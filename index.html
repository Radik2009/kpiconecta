<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Conecta • Portal Operacional & RH (V5)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .glass { background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
    .card { border: 1px solid rgba(148,163,184,.35); }
    .muted { color: rgb(100 116 139); }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .chip { border: 1px solid rgba(148,163,184,.45); }
    .shadowSoft { box-shadow: 0 10px 30px rgba(2,6,23,.08); }
    .shadowMedium { box-shadow: 0 15px 40px rgba(2,6,23,.12); }
    .shadowStrong { box-shadow: 0 20px 50px rgba(2,6,23,.15); }
    .btn { border: 1px solid rgba(148,163,184,.55); }
    .btnPrimary { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
    .btnPrimary:hover { filter: brightness(1.08); }
    .btn:hover { background: rgb(248 250 252); }
    .kpiVal { letter-spacing: -0.02em; }
    .activeNav { background: rgba(15,23,42,.08); border-color: rgba(15,23,42,.18); }
    
    /* Estilos para alertas */
    .alert-high { border-left: 4px solid #ef4444; background-color: #fef2f2; }
    .alert-medium { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
    .alert-low { border-left: 4px solid #3b82f6; background-color: #eff6ff; }
    .alert-expanded { background-color: #f8fafc; }
    .alert-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .alert-details.open { max-height: 500px; }
    
    /* Estilos para análise mensal */
    .month-analysis { border-left: 4px solid #10b981; }
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .trend-neutral { color: #6b7280; }
    
    /* Estilos para impressão */
    @media print {
      body * {
        visibility: hidden;
      }
      #printableAlerts, #printableAlerts * {
        visibility: visible;
      }
      #printableAlerts {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-900">
  <!-- BACKGROUND -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-24 -left-24 w-[520px] h-[520px] rounded-full blur-3xl opacity-35 bg-gradient-to-br from-emerald-400 to-cyan-400"></div>
    <div class="absolute -bottom-24 -right-24 w-[520px] h-[520px] rounded-full blur-3xl opacity-30 bg-gradient-to-br from-fuchsia-400 to-indigo-400"></div>
  </div>

  <div class="max-w-[1400px] mx-auto px-4 py-4">
    <!-- TOP BAR -->
    <header class="glass shadowStrong card rounded-2xl px-4 py-4 flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-semibold shadowMedium">SC</div>
        <div>
          <div class="text-xl font-semibold text-slate-900">Portal • Operacional & RH</div>
          <div class="text-xs muted">KPIs • Mix • Equip líderes por tipo • Comparação mês • Saúde por equipamento (todos) • Alertas</div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label class="btn btnPrimary px-3 py-2 rounded-xl cursor-pointer text-sm shadowSoft hover:shadowMedium">
          Carregar XLSX
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden"/>
        </label>

        <!-- NOVO BOTÃO ABASTECIMENTO - ABRE EM NOVA ABA -->
        <button id="btnAbastecimento" class="btn px-3 py-2 rounded-xl bg-white text-sm shadowSoft hover:shadowMedium flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Abastecimento
        </button>

        <div class="flex items-center gap-2">
          <div class="text-xs muted">Módulo</div>
          <select id="moduleSel" class="btn px-3 py-2 rounded-xl bg-white text-sm shadowSoft">
            <option value="operacoes" selected>Operacional</option>
            <option value="rh">RH</option>
          </select>
        </div>

        <button id="btnReset" class="btn px-3 py-2 rounded-xl bg-white text-sm shadowSoft">Reset</button>

        <button id="btnExportCSV" class="btn px-3 py-2 rounded-xl bg-white text-sm disabled:opacity-50 shadowSoft" disabled>CSV</button>
        <button id="btnExportJSON" class="btn px-3 py-2 rounded-xl bg-white text-sm disabled:opacity-50 shadowSoft" disabled>JSON</button>
      </div>
    </header>

    <!-- Resto do código permanece igual... -->
    <!-- ... -->
    
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-4">
      <!-- SIDEBAR -->
      <aside class="lg:col-span-3">
        <div class="glass shadowMedium card rounded-2xl p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Navegação</div>
            <div class="w-2.5 h-2.5 rounded-full bg-slate-300" id="dotStatus"></div>
          </div>

          <div class="text-xs muted mt-1" id="statusLine">Carregue um XLSX para iniciar.</div>

          <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
            <div class="chip rounded-xl p-2 bg-white shadowSoft">
              <div class="muted">Registros</div>
              <div class="mono font-semibold" id="metaTotal">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white shadowSoft">
              <div class="muted">Período</div>
              <div class="mono font-semibold" id="metaPeriod">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white shadowSoft">
              <div class="muted">Equip col.</div>
              <div class="mono font-semibold" id="metaEquip">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white shadowSoft">
              <div class="muted">Após filtros</div>
              <div class="mono font-semibold" id="metaFiltered">—</div>
            </div>
          </div>

          <div class="mt-4 space-y-2">
            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white activeNav shadowSoft" data-page="dashboard">
              <div class="text-sm font-semibold">Dashboard</div>
              <div class="text-xs muted">KPIs + gráficos + insights</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white shadowSoft" data-page="comparativo">
              <div class="text-sm font-semibold">Comparação mês</div>
              <div class="text-xs muted">Análise mensal por tipo de serviço</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white shadowSoft" data-page="registros">
              <div class="text-sm font-semibold">Registros</div>
              <div class="text-xs muted">Tabela filtrada + drill</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white shadowSoft" data-page="alertas">
              <div class="text-sm font-semibold">Alertas</div>
              <div class="text-xs muted">Clientes problemáticos + situações críticas</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white shadowSoft" data-page="acrescimos">
              <div class="text-sm font-semibold">Efetividade dos acréscimos</div>
              <div class="text-xs muted">Análise de reincidência pós-acréscimo</div>
            </button>
          </div>

          <div class="mt-4 text-xs muted">
            Dica: clique em <b>Cliente</b> ou <b>Técnico</b> na tabela para drill-down.
          </div>
        </div>

        <!-- FILTERS -->
        <div class="glass shadowMedium card rounded-2xl p-3 mt-4">
          <div class="text-sm font-semibold">Filtros</div>
          <div class="text-xs muted">Aplique e o portal recalcula tudo.</div>

          <div class="mt-3">
            <label class="text-xs muted">Base</label>
            <select id="fBase" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
              <option value="">(Conecta + Visium)</option>
              <option value="Conecta">Conecta</option>
              <option value="Visium">Visium</option>
            </select>
          </div>

          <div id="wrapCliente" class="mt-3">
            <label class="text-xs muted">Cliente (busca)</label>
            <input id="clientSearch" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft" placeholder="Digite e selecione…"/>
            <div id="clientSuggest" class="hidden mt-1 border rounded-xl bg-white max-h-56 overflow-auto shadowMedium"></div>

            <label class="text-xs muted mt-2 block">Cliente (filtro)</label>
            <select id="fCliente" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Técnico</label>
            <select id="fTecnico" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Tipo de chamado</label>
            <select id="fTipo" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
              <option value="">(Todos)</option>
            </select>
            <div class="text-[11px] muted mt-1">Padronizado para: Montagem, Manutenção, Retirada, Troca, Revisão.</div>
          </div>

          <div class="mt-3" id="wrapEquip">
            <label class="text-xs muted">Equipamento (coluna)</label>
            <select id="fEquip" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <div>
              <label class="text-xs muted">De</label>
              <input id="fDe" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
            </div>
            <div>
              <label class="text-xs muted">Até</label>
              <input id="fAte" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Busca geral</label>
            <input id="fSearch" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft" placeholder="Ex.: retirada, All Easy, 28946…"/>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <div>
              <label class="text-xs muted">Alerta: dias entre manutenções</label>
              <input id="alertDias" type="number" min="1" value="30" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
            </div>
            <div>
              <label class="text-xs muted">Min. manutenções</label>
              <input id="alertMinManut" type="number" min="2" value="3" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
            </div>
          </div>

          <!-- NEW: Health window for ALL equipment -->
          <div id="wrapHealthWin" class="mt-3">
            <label class="text-xs muted">Saúde: janela pós-montagem (dias)</label>
            <input id="healthWindowDays" type="number" min="1" value="14" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
            <div class="text-[11px] muted mt-1">Detecta Manutenção até X dias após Montagem (entrega=montagem), por cliente + coluna de equipamento.</div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <section class="lg:col-span-9 space-y-4">
        <!-- PAGE: DASHBOARD -->
        <div id="page-dashboard" class="glass shadowMedium card rounded-2xl p-4">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-semibold">Dashboard</div>
              <div class="text-xs muted">KPIs do recorte + mix + equipamentos + saúde por equipamento</div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs shadowSoft">
                <span class="muted">Mês detectado:</span> <span class="mono font-semibold" id="currentMonthLabel">—</span>
              </div>
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs shadowSoft">
                <span class="muted">Tendência:</span> <span class="mono font-semibold" id="trendLabel">—</span>
              </div>
            </div>
          </div>

          <div id="kpiGrid" class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4"></div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-4">
            <div class="card rounded-2xl p-3 bg-white shadowMedium">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Chamados por dia</div>
                <div class="text-xs muted" id="g1meta">—</div>
              </div>
              <canvas id="chart1" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white shadowMedium">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Mix de tipo</div>
                <div class="text-xs muted" id="g2meta">—</div>
              </div>
              <canvas id="chart2" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white shadowMedium">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold" id="g3title">Top clientes (volume)</div>
                <div class="text-xs muted" id="g3meta">—</div>
              </div>
              <canvas id="chart3" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white shadowMedium">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Top equipamentos (qty)</div>
                <div class="text-xs muted" id="g4meta">—</div>
              </div>
              <canvas id="chart4" height="120"></canvas>
            </div>
          </div>

          <!-- OP: equipamento líder por tipo dominante -->
          <div id="opDominantEquip" class="hidden mt-4 card rounded-2xl p-4 bg-white shadowMedium"></div>

          <!-- OP: Health (ALL equipment) -->
          <div id="equipHealthWrap" class="hidden mt-4 card rounded-2xl p-4 bg-white shadowMedium"></div>
        </div>

        <!-- PAGE: COMPARATIVO -->
        <div id="page-comparativo" class="hidden glass shadowMedium card rounded-2xl p-4">
          <div class="flex items-start justify-between flex-wrap gap-3">
            <div>
              <div class="text-lg font-semibold">Comparação mensal - Análise Detalhada</div>
              <div class="text-xs muted">Selecione um mês para análise detalhada ou múltiplos meses para comparação.</div>
            </div>
          </div>

          <!-- Seletor de meses -->
          <div class="mt-4 card rounded-2xl p-3 bg-white shadowMedium">
            <div class="text-sm font-semibold">Selecione os meses para análise</div>
            <div class="text-xs muted mt-1">Clique nos meses que deseja incluir na análise. Selecione apenas um para análise detalhada.</div>
            <div id="monthsCheckboxContainer" class="mt-3 flex flex-wrap gap-2"></div>
            <div class="mt-2 text-xs muted">
              <b>Dica:</b> Selecione apenas um mês para ver análise detalhada (cliente com mais manutenção/montagem, equipamento problemático).
            </div>
          </div>

          <!-- Análise detalhada de um único mês -->
          <div id="monthDetailedAnalysis" class="mt-4 hidden">
            <!-- Será preenchido dinamicamente quando apenas um mês for selecionado -->
          </div>

          <!-- KPIs por mês (para múltiplos meses) -->
          <div id="monthlyKPIs" class="mt-4"></div>

          <!-- Gráficos de comparação (para múltiplos meses) -->
          <div id="comparisonCharts" class="hidden mt-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div class="card rounded-2xl p-3 bg-white shadowMedium">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-semibold">Comparação por tipo de serviço</div>
                  <div class="text-xs muted" id="compareMeta1">—</div>
                </div>
                <canvas id="compareChart1" height="160"></canvas>
              </div>

              <div class="card rounded-2xl p-3 bg-white shadowMedium">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-semibold">Evolução mensal total</div>
                  <div class="text-xs muted" id="compareMeta2">—</div>
                </div>
                <canvas id="compareChart2" height="160"></canvas>
              </div>
            </div>

            <!-- Tabela comparativa com análise de tendência -->
            <div class="mt-4 card rounded-2xl p-3 bg-white shadowMedium">
              <div class="text-sm font-semibold">Tabela comparativa detalhada com Análise de Tendência</div>
              <div class="text-xs muted">Valores por tipo de serviço em cada mês selecionado + variação percentual</div>
              <div class="mt-3 overflow-auto border rounded-2xl shadowSoft">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-100">
                    <tr class="text-left">
                      <th class="p-2">Tipo</th>
                      <!-- Cabeçalhos serão preenchidos dinamicamente -->
                    </tr>
                  </thead>
                  <tbody id="compareTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- PAGE: REGISTROS -->
        <div id="page-registros" class="hidden glass shadowMedium card rounded-2xl p-4">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <div class="text-lg font-semibold">Registros</div>
              <div class="text-xs muted">Tabela filtrada. Clique em Cliente/Técnico para drill-down.</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs muted">Linhas:</span>
              <select id="pageSize" class="btn px-2 py-1 rounded-xl bg-white text-sm shadowSoft">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="250">250</option>
              </select>
            </div>
          </div>

          <div class="overflow-auto mt-3 border rounded-2xl bg-white shadowMedium">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 sticky top-0">
                <tr class="text-left">
                  <th class="p-2">Base</th>
                  <th class="p-2">Data</th>
                  <th class="p-2">Chamado</th>
                  <th class="p-2">Cliente</th>
                  <th class="p-2">Técnico</th>
                  <th class="p-2">Tipo</th>
                  <th class="p-2">Acrésc.</th>
                  <th class="p-2">Motivo</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="flex items-center justify-between mt-3">
            <div class="text-xs muted" id="pagerInfo">—</div>
            <div class="flex items-center gap-2">
              <button id="btnPrev" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Anterior</button>
              <button id="btnNext" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Próximo</button>
            </div>
          </div>
        </div>

        <!-- PAGE: ALERTAS (NOVA) -->
        <div id="page-alertas" class="hidden glass shadowMedium card rounded-2xl p-4">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
            <div>
              <div class="text-lg font-semibold">Alertas - Situações Críticas</div>
              <div class="text-xs muted">Clientes com múltiplas manutenções em pouco tempo. Clique para expandir detalhes.</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs shadowSoft">
                <span class="muted">Período de alerta:</span> 
                <span class="mono font-semibold" id="alertPeriodLabel">30 dias</span>
              </div>
              <button id="btnRefreshAlerts" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Atualizar alertas</button>
              <button id="btnPrintAlerts" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Imprimir alertas</button>
            </div>
          </div>

          <!-- Resumo dos alertas -->
          <div id="alertSummary" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Será preenchido dinamicamente -->
          </div>

          <!-- Lista de alertas -->
          <div id="alertsContainer">
            <div class="text-sm muted text-center p-4" id="noAlertsMessage">
              Nenhum alerta encontrado. Ajuste os parâmetros ou carregue mais dados.
            </div>
            <!-- Alertas serão inseridos aqui -->
          </div>

          <!-- Legenda -->
          <div class="mt-4 p-3 bg-white border rounded-xl shadowSoft">
            <div class="text-sm font-semibold mb-2">Legenda dos alertas:</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span><b>Alta criticidade:</b> 5+ manutenções em 30 dias</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <span><b>Média criticidade:</b> 3-4 manutenções em 30 dias</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <span><b>Baixa criticidade:</b> Múltiplas manutenções (check padrão)</span>
              </div>
            </div>
            <div class="mt-2 text-xs muted">
              <b>Nota:</b> Alertas consideram apenas chamados do tipo "Manutenção" dentro do período configurado.
            </div>
          </div>
        </div>

        <!-- PAGE: ACRÉSCIMOS (NOVA) -->
        <div id="page-acrescimos" class="hidden glass shadowMedium card rounded-2xl p-4">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
            <div>
              <div class="text-lg font-semibold">Efetividade dos Acréscimos</div>
              <div class="text-xs muted">Análise de reincidência após acréscimos. Detectar se teve acréscimo e logo depois outro chamado.</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs shadowSoft">
                <span class="muted">Período de análise:</span> 
                <span class="mono font-semibold" id="acrescPeriodLabel">7 dias</span>
              </div>
              <button id="btnRefreshAcresc" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Atualizar análise</button>
            </div>
          </div>

          <!-- Controles -->
          <div class="card rounded-2xl p-4 bg-white shadowMedium mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="text-xs muted">Dias para análise pós-acréscimo</label>
                <input id="acrescWindowDays" type="number" min="1" value="7" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft"/>
              </div>
              <div>
                <label class="text-xs muted">Tipo de chamado considerado</label>
                <select id="acrescTipo" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft">
                  <option value="">Todos os tipos</option>
                  <option value="Manutenção" selected>Manutenção</option>
                  <option value="Retirada">Retirada</option>
                  <option value="Troca">Troca</option>
                  <option value="Revisão">Revisão</option>
                </select>
              </div>
              <div>
                <label class="text-xs muted">Cliente específico (opcional)</label>
                <input id="acrescCliente" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white shadowSoft" placeholder="Digite o nome do cliente"/>
              </div>
            </div>
          </div>

          <!-- KPIs de acréscimos -->
          <div id="acrescSummary" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Será preenchido dinamicamente -->
          </div>

          <!-- Análise detalhada -->
          <div class="card rounded-2xl p-4 bg-white shadowMedium">
            <div class="text-sm font-semibold mb-2">Casos de reincidência pós-acréscimo</div>
            <div class="text-xs muted mb-3">Clientes que tiveram acréscimo e depois outro chamado dentro do período configurado.</div>
            
            <div class="overflow-auto border rounded-xl shadowSoft">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-100">
                  <tr class="text-left">
                    <th class="p-2">Cliente</th>
                    <th class="p-2">Data acréscimo</th>
                    <th class="p-2">Chamado com acrésc.</th>
                    <th class="p-2">Próximo chamado</th>
                    <th class="p-2">Δ dias</th>
                    <th class="p-2">Tipo</th>
                    <th class="p-2">Motivo</th>
                    <th class="p-2">Ações</th>
                  </tr>
                </thead>
                <tbody id="acrescTableBody">
                  <!-- Será preenchido dinamicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- DRILL MODAL -->
  <div id="drillModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="glass shadowStrong card rounded-2xl w-full max-w-6xl p-0 overflow-hidden">
      <div class="px-4 py-3 border-b bg-white flex items-start justify-between gap-3">
        <div>
          <div class="text-lg font-semibold" id="dTitle">Drill-down</div>
          <div class="text-xs muted" id="dSub">—</div>
        </div>
        <button id="dClose" class="btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft">Fechar</button>
      </div>

      <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="card rounded-2xl p-3 bg-white shadowMedium">
          <div class="text-xs muted">KPIs</div>
          <div id="dKpis" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white lg:col-span-2 shadowMedium">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Linha do tempo</div>
            <div class="text-xs muted" id="dMeta">—</div>
          </div>
          <canvas id="dChart" height="110"></canvas>
        </div>

        <div class="card rounded-2xl p-3 bg-white shadowMedium">
          <div class="text-sm font-semibold">Top clientes</div>
          <div id="dTopClients" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white shadowMedium">
          <div class="text-sm font-semibold">Top motivos</div>
          <div id="dTopReasons" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white shadowMedium">
          <div class="text-sm font-semibold">Top equipamentos</div>
          <div id="dTopEquip" class="mt-2 space-y-1 text-sm"></div>
        </div>
      </div>

      <div class="px-4 py-3 border-t bg-white text-xs muted">
        Reincidência: mesmo cliente + motivo similar dentro da janela configurada.
      </div>
    </div>
  </div>

  <!-- CONTEÚDO PARA IMPRESSÃO (HIDDEN) -->
  <div id="printableAlerts" class="hidden">
    <!-- Será preenchido dinamicamente quando imprimir -->
  </div>

<script>
/* =========================
   BASE
========================= */
const FIXED_FIELDS = new Set([
  "Data","Empresa","Chamados","Chamado","Cliente","Cliente/Empresa","Motivo","tecnico","Técnico","Tecnico",
  "Ajudante","carro","Acrescimo","Acréscimo","Hora Inicio","Hora Final","Tipo de chamado","Tipo",
  "Total Horas","Horas","Total KM","KM Inicio","KM Final","KM inico","Base","Unidade"
]);

const VALID_TIPOS = ["Montagem","Manutenção","Retirada","Troca","Revisão"];

const el = (id)=>document.getElementById(id);
const safeStr = (v)=>String(v ?? "").replace(/\s+/g," ").trim();
const normKey = (k)=>String(k ?? "").trim();

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
const mono = (v)=>`<span class="mono font-semibold">${escapeHtml(v)}</span>`;

function toInt(v){
  const n = Number(String(v ?? "").replace(",","."));
  return Number.isFinite(n) ? n : 0;
}

function toISODate(v){
  if (v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
  if (typeof v === "number") {
    const d = XLSX.SSF.parse_date_code(v);
    if (d) {
      const dt = new Date(Date.UTC(d.y, d.m - 1, d.d));
      return dt.toISOString().slice(0,10);
    }
  }
  const s = String(v ?? "").trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) return s;
  return "";
}

function daysBetween(isoA, isoB){
  if (!isoA || !isoB) return null;
  const a = new Date(isoA+"T00:00:00Z").getTime();
  const b = new Date(isoB+"T00:00:00Z").getTime();
  return Math.round((b-a)/(1000*60*60*24));
}
function monthKey(iso){ return (!iso || iso.length<7) ? "" : iso.slice(0,7); }
function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b), "pt-BR")); }
function groupCount(arr, keyFn){
  const m = new Map();
  for (const it of arr){
    const k = keyFn(it) || "(vazio)";
    m.set(k, (m.get(k) || 0) + 1);
  }
  return m;
}
function topN(map, n=10){ return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n); }
function destroyIfExists(ch){ if (ch && typeof ch.destroy==="function") ch.destroy(); }

function motivoTokens(m){ return safeStr(m).toLowerCase().split(/[^a-zà-ú0-9]+/i).filter(x=>x.length>=3); }
function motivoSimilar(a, b, minCommon=2){
  if (!a || !b) return false;
  const A = new Set(motivoTokens(a));
  const B = new Set(motivoTokens(b));
  let common = 0;
  for (const x of A) if (B.has(x)) { common++; if (common>=minCommon) return true; }
  return false;
}

/* =========================
   ESTADO
========================= */
let rawRecords = [];
let equipColumns = [];
let filtered = [];
let page = 1;
let pageSize = 50;
let healthSelectedCol = null;
let selectedMonths = new Set();
let alertsData = [];

let chart1, chart2, chart3, chart4;
let compareChart1, compareChart2;
let dChart;

/* =========================
   ELEMENTOS
========================= */
const fileInput = el("fileInput");
const dotStatus = el("dotStatus");
const statusLine= el("statusLine");
const moduleSel = el("moduleSel");
const btnReset  = el("btnReset");
const btnExportCSV = el("btnExportCSV");
const btnExportJSON= el("btnExportJSON");
const btnAbastecimento = el("btnAbastecimento");

const metaTotal = el("metaTotal");
const metaPeriod= el("metaPeriod");
const metaEquip = el("metaEquip");
const metaFiltered = el("metaFiltered");

const fBase   = el("fBase");
const fCliente = el("fCliente");
const fTecnico = el("fTecnico");
const fTipo    = el("fTipo");
const fEquip   = el("fEquip");
const fDe      = el("fDe");
const fAte     = el("fAte");
const fSearch  = el("fSearch");
const alertDias = el("alertDias");
const alertMinManut = el("alertMinManut");
const healthWindowDays = el("healthWindowDays");

const wrapCliente = el("wrapCliente");
const wrapEquip   = el("wrapEquip");

const clientSearch = el("clientSearch");
const clientSuggest= el("clientSuggest");

const kpiGrid = el("kpiGrid");
const currentMonthLabel = el("currentMonthLabel");
const trendLabel = el("trendLabel");

const opDominantEquip = el("opDominantEquip");
const equipHealthWrap = el("equipHealthWrap");

const pageSizeSel= el("pageSize");
const tbody = el("tbody");
const pagerInfo = el("pagerInfo");
const btnPrev = el("btnPrev");
const btnNext = el("btnNext");

const navBtns = document.querySelectorAll(".navBtn");
const pages = {
  dashboard: el("page-dashboard"),
  comparativo: el("page-comparativo"),
  registros: el("page-registros"),
  alertas: el("page-alertas"),
  acrescimos: el("page-acrescimos")
};

// Elementos da página de comparação
const monthsCheckboxContainer = el("monthsCheckboxContainer");
const monthDetailedAnalysis = el("monthDetailedAnalysis");
const monthlyKPIs = el("monthlyKPIs");
const comparisonCharts = el("comparisonCharts");
const compareTableBody = el("compareTableBody");

// Elementos da página de alertas
const alertPeriodLabel = el("alertPeriodLabel");
const btnRefreshAlerts = el("btnRefreshAlerts");
const btnPrintAlerts = el("btnPrintAlerts");
const alertSummary = el("alertSummary");
const alertsContainer = el("alertsContainer");
const noAlertsMessage = el("noAlertsMessage");

// Elementos da página de acréscimos
const acrescPeriodLabel = el("acrescPeriodLabel");
const btnRefreshAcresc = el("btnRefreshAcresc");
const acrescWindowDays = el("acrescWindowDays");
const acrescTipo = el("acrescTipo");
const acrescCliente = el("acrescCliente");
const acrescSummary = el("acrescSummary");
const acrescTableBody = el("acrescTableBody");

// Drill
const drillModal = el("drillModal");
const dClose = el("dClose");
const dTitle = el("dTitle");
const dSub   = el("dSub");
const dMeta  = el("dMeta");
const dKpis  = el("dKpis");
const dTopClients = el("dTopClients");
const dTopReasons = el("dTopReasons");
const dTopEquip   = el("dTopEquip");

// ==================== FUNÇÃO PARA ABRIR ABASTECIMENTO ====================
btnAbastecimento.addEventListener("click", () => {
  window.open('abastecimento.html', '_blank');
});

/* =========================
   NORMALIZAÇÃO
========================= */
function inferBase(obj, sheetName){
  const b = safeStr(obj["Base"] || obj["Empresa"] || "");
  const s = (sheetName||"").toLowerCase();
  const bb = b.toLowerCase();
  if (bb.includes("visium") || s.includes("visium")) return "Visium";
  if (bb.includes("conecta") || s.includes("conecta") || s.includes("smart")) return "Conecta";
  return "Conecta";
}

function normalizeTipo(rawTipo){
  const t = safeStr(rawTipo).toLowerCase();
  if (!t) return "";
  if (t.includes("mont")) return "Montagem";
  if (t.includes("retir")) return "Retirada";
  if (t.includes("manut")) return "Manutenção";
  if (t.includes("troc")) return "Troca";
  if (t.includes("revis")) return "Revisão";
  const cap = t.charAt(0).toUpperCase()+t.slice(1);
  return VALID_TIPOS.includes(cap) ? cap : cap;
}

function normalizeRow(raw, sheetName){
  const obj = {};
  for (const [k,v] of Object.entries(raw)) obj[normKey(k)] = v;

  const dataISO = toISODate(obj["Data"]);
  const chamado = safeStr(obj["Chamados"] || obj["Chamado"] || "");
  const cliente = safeStr(obj["Cliente"] || obj["Empresa"] || obj["Cliente/Empresa"] || "");
  const tecnico = safeStr(obj["tecnico"] || obj["Técnico"] || obj["Tecnico"] || "");
  const tipo    = normalizeTipo(obj["Tipo de chamado"] || obj["Tipo"] || "");
  const motivo  = safeStr(obj["Motivo"] || "");
  const acresc  = toInt(obj["Acrescimo"] || obj["Acréscimo"] || 0);

  const base = inferBase(obj, sheetName);

  return {
    sheet: sheetName,
    base,
    carro: safeStr(obj["carro"] || obj["Carro"] || ""),
    data: dataISO,
    month: monthKey(dataISO),
    chamado, cliente, tecnico, tipo, motivo,
    acrescimo: acresc,
    _raw: obj
  };
}

async function loadXLSX(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array", cellDates:true});
  const all = [];
  for (const name of wb.SheetNames){
    const ws = wb.Sheets[name];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
    for (const row of rows){
      const hasAny = Object.values(row).some(v => String(v ?? "").trim() !== "");
      if (!hasAny) continue;
      all.push(normalizeRow(row, name));
    }
  }
  return all;
}

function detectEquipColumns(records){
  const sums = new Map();
  for (const r of records){
    for (const [k,v] of Object.entries(r._raw || {})){
      const kk = normKey(k);
      if (!kk) continue;
      if (FIXED_FIELDS.has(kk)) continue;
      if (/^Unnamed/i.test(kk)) continue;
      const num = toInt(v);
      if (num > 0) sums.set(kk, (sums.get(kk)||0) + num);
    }
  }
  return [...sums.entries()].sort((a,b)=>b[1]-a[1]).map(([k])=>k);
}

/* =========================
   SISTEMA DE ALERTAS
========================= */
function detectAlerts() {
  const daysWindow = Math.max(1, toInt(alertDias.value));
  const minManut = Math.max(2, toInt(alertMinManut.value));
  
  alertPeriodLabel.textContent = `${daysWindow} dias`;
  
  // Filtrar apenas manutenções
  const manutencaoRecords = filtered.filter(r => r.tipo === "Manutenção");
  
  if (manutencaoRecords.length === 0) {
    alertsData = [];
    return;
  }
  
  // Agrupar por cliente
  const byClient = new Map();
  for (const r of manutencaoRecords) {
    const key = r.cliente || "(vazio)";
    if (!byClient.has(key)) byClient.set(key, []);
    byClient.get(key).push(r);
  }
  
  // Analisar cada cliente
  const alerts = [];
  
  for (const [cliente, records] of byClient.entries()) {
    if (records.length < minManut) continue;
    
    // Ordenar por data
    const sorted = records.filter(r => r.data).sort((a, b) => a.data.localeCompare(b.data));
    
    if (sorted.length < minManut) continue;
    
    // Verificar se há manutenções próximas no tempo
    let hasCloseManut = false;
    let maxInWindow = 0;
    let windowStart = null;
    let problematicDates = [];
    
    for (let i = 0; i < sorted.length; i++) {
      const current = sorted[i];
      let countInWindow = 1;
      const windowDates = [current.data];
      
      for (let j = i + 1; j < sorted.length; j++) {
        const next = sorted[j];
        const days = daysBetween(current.data, next.data);
        if (days !== null && days <= daysWindow) {
          countInWindow++;
          windowDates.push(next.data);
        } else {
          break;
        }
      }
      
      if (countInWindow >= minManut) {
        hasCloseManut = true;
        if (countInWindow > maxInWindow) {
          maxInWindow = countInWindow;
          problematicDates = windowDates;
          windowStart = current.data;
        }
      }
    }
    
    if (hasCloseManut) {
      // Calcular criticidade
      let severity = "low";
      if (maxInWindow >= 5) severity = "high";
      else if (maxInWindow >= 3) severity = "medium";
      
      // Coletar equipamentos únicos
      const equipamentos = new Set();
      records.forEach(r => {
        for (const col of equipColumns) {
          const qty = toInt((r._raw||{})[col]);
          if (qty > 0) equipamentos.add(col);
        }
      });
      
      // Coletar técnicos únicos
      const tecnicos = new Set(records.map(r => r.tecnico).filter(Boolean));
      
      // Coletar motivos comuns
      const motivos = new Map();
      records.forEach(r => {
        const motivo = r.motivo || "(sem motivo)";
        motivos.set(motivo, (motivos.get(motivo) || 0) + 1);
      });
      const topMotivos = topN(motivos, 3);
      
      alerts.push({
        cliente,
        totalManut: records.length,
        maxInWindow,
        windowDays: daysWindow,
        severity,
        problematicDates,
        windowStart,
        equipamentos: Array.from(equipamentos),
        tecnicos: Array.from(tecnicos),
        topMotivos,
        records: sorted // Manter os registros ordenados
      });
    }
  }
  
  // Ordenar por criticidade (alta primeiro) e depois por quantidade
  alerts.sort((a, b) => {
    const severityOrder = { high: 3, medium: 2, low: 1 };
    if (severityOrder[b.severity] !== severityOrder[a.severity]) {
      return severityOrder[b.severity] - severityOrder[a.severity];
    }
    return b.maxInWindow - a.maxInWindow;
  });
  
  alertsData = alerts;
}

function renderAlerts() {
  detectAlerts();
  
  // Atualizar resumo
  renderAlertSummary();
  
  // Limpar container
  alertsContainer.innerHTML = '';
  
  if (alertsData.length === 0) {
    noAlertsMessage.classList.remove('hidden');
    return;
  }
  
  noAlertsMessage.classList.add('hidden');
  
  // Renderizar cada alerta
  alertsData.forEach((alert, index) => {
    const alertElement = createAlertElement(alert, index);
    alertsContainer.appendChild(alertElement);
  });
}

function renderAlertSummary() {
  const high = alertsData.filter(a => a.severity === 'high').length;
  const medium = alertsData.filter(a => a.severity === 'medium').length;
  const low = alertsData.filter(a => a.severity === 'low').length;
  const total = alertsData.length;
  
  alertSummary.innerHTML = `
    <div class="card rounded-2xl p-4 bg-white shadowMedium">
      <div class="text-xs muted">Total de alertas</div>
      <div class="text-2xl font-semibold mono">${total}</div>
      <div class="text-xs muted">Clientes problemáticos</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-high shadowMedium">
      <div class="text-xs muted">Alta criticidade</div>
      <div class="text-2xl font-semibold mono">${high}</div>
      <div class="text-xs muted">5+ manutenções</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-medium shadowMedium">
      <div class="text-xs muted">Média criticidade</div>
      <div class="text-2xl font-semibold mono">${medium}</div>
      <div class="text-xs muted">3-4 manutenções</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-low shadowMedium">
      <div class="text-xs muted">Baixa criticidade</div>
      <div class="text-2xl font-semibold mono">${low}</div>
      <div class="text-xs muted">Múltiplas manutenções</div>
    </div>
  `;
}

function createAlertElement(alert, index) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `mb-3 card rounded-2xl p-4 alert-${alert.severity} shadowMedium`;
  alertDiv.id = `alert-${index}`;
  
  // Cabeçalho do alerta
  const header = document.createElement('div');
  header.className = 'flex items-start justify-between cursor-pointer';
  header.addEventListener('click', () => toggleAlertDetails(index));
  
  const severityBadge = document.createElement('span');
  severityBadge.className = 'px-2 py-1 rounded text-xs font-semibold';
  
  if (alert.severity === 'high') {
    severityBadge.textContent = 'ALTA';
    severityBadge.className += ' bg-red-100 text-red-800';
  } else if (alert.severity === 'medium') {
    severityBadge.textContent = 'MÉDIA';
    severityBadge.className += ' bg-yellow-100 text-yellow-800';
  } else {
    severityBadge.textContent = 'BAIXA';
    severityBadge.className += ' bg-blue-100 text-blue-800';
  }
  
  header.innerHTML = `
    <div class="flex-1">
      <div class="flex items-center gap-2">
        <div class="text-lg font-semibold">${escapeHtml(alert.cliente)}</div>
        ${severityBadge.outerHTML}
      </div>
      <div class="text-xs muted mt-1">
        ${alert.totalManut} manutenções no total • 
        ${alert.maxInWindow} manutenções em ${alert.windowDays} dias •
        Início: ${alert.windowStart || 'N/A'}
      </div>
    </div>
    <div class="text-2xl mono font-semibold ml-2">${alert.maxInWindow}×</div>
  `;
  
  alertDiv.appendChild(header);
  
  // Detalhes do alerta (inicialmente ocultos)
  const details = document.createElement('div');
  details.className = 'alert-details mt-3';
  details.id = `alert-details-${index}`;
  
  // Estatísticas
  const statsDiv = document.createElement('div');
  statsDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 mb-3';
  
  statsDiv.innerHTML = `
    <div class="bg-white p-3 rounded-xl border shadowSoft">
      <div class="text-xs muted">Equipamentos</div>
      <div class="text-sm mt-1">
        ${alert.equipamentos.length > 0 
          ? alert.equipamentos.map(e => `<div class="truncate">${escapeHtml(e)}</div>`).join('')
          : '<div class="text-muted">Nenhum equipamento identificado</div>'}
      </div>
    </div>
    
    <div class="bg-white p-3 rounded-xl border shadowSoft">
      <div class="text-xs muted">Técnicos envolvidos</div>
      <div class="text-sm mt-1">
        ${alert.tecnicos.length > 0 
          ? alert.tecnicos.map(t => `<div>${escapeHtml(t)}</div>`).join('')
          : '<div class="text-muted">Nenhum técnico identificado</div>'}
      </div>
    </div>
    
    <div class="bg-white p-3 rounded-xl border shadowSoft">
      <div class="text-xs muted">Motivos mais comuns</div>
      <div class="text-sm mt-1">
        ${alert.topMotivos.length > 0 
          ? alert.topMotivos.map(([motivo, count]) => `<div class="truncate">${escapeHtml(motivo)} (${count})</div>`).join('')
          : '<div class="text-muted">Nenhum motivo registrado</div>'}
      </div>
    </div>
  `;
  
  details.appendChild(statsDiv);
  
  // Tabela de registros
  const tableTitle = document.createElement('div');
  tableTitle.className = 'text-sm font-semibold mb-2';
  tableTitle.textContent = 'Registros de manutenção (ordenados por data)';
  details.appendChild(tableTitle);
  
  const tableContainer = document.createElement('div');
  tableContainer.className = 'overflow-auto border rounded-xl shadowSoft';
  
  const table = document.createElement('table');
  table.className = 'min-w-full text-sm';
  
  table.innerHTML = `
    <thead class="bg-slate-100">
      <tr class="text-left">
        <th class="p-2">Data</th>
        <th class="p-2">Chamado</th>
        <th class="p-2">Técnico</th>
        <th class="p-2">Acrésc.</th>
        <th class="p-2">Motivo</th>
        <th class="p-2">Equipamentos</th>
      </tr>
    </thead>
    <tbody id="alert-table-${index}">
      <!-- Linhas serão preenchidas abaixo -->
    </tbody>
  `;
  
  const tbody = table.querySelector(`#alert-table-${index}`);
  
  // Limitar a 20 registros para não ficar muito longo
  const displayRecords = alert.records.slice(0, 20);
  
  displayRecords.forEach(record => {
    // Identificar equipamentos nesta manutenção
    const recordEquip = [];
    for (const col of equipColumns) {
      const qty = toInt((record._raw||{})[col]);
      if (qty > 0) recordEquip.push(`${col} (${qty})`);
    }
    
    const tr = document.createElement('tr');
    tr.className = 'border-t hover:bg-slate-50';
    
    tr.innerHTML = `
      <td class="p-2 mono">${record.data || ''}</td>
      <td class="p-2 mono">${escapeHtml(record.chamado)}</td>
      <td class="p-2">${escapeHtml(record.tecnico)}</td>
      <td class="p-2 mono">${record.acrescimo || 0}</td>
      <td class="p-2">${escapeHtml(record.motivo)}</td>
      <td class="p-2 text-xs">${recordEquip.length > 0 ? recordEquip.join(', ') : '—'}</td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Adicionar mensagem se houver mais registros
  if (alert.records.length > 20) {
    const tr = document.createElement('tr');
    tr.className = 'border-t bg-slate-50';
    tr.innerHTML = `
      <td class="p-2 text-center muted" colspan="6">
        ... e mais ${alert.records.length - 20} registro(s)
      </td>
    `;
    tbody.appendChild(tr);
  }
  
  tableContainer.appendChild(table);
  details.appendChild(tableContainer);
  
  // Ações
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'flex justify-between items-center mt-3 pt-3 border-t';
  
  const infoText = document.createElement('div');
  infoText.className = 'text-xs muted';
  infoText.textContent = 'Este cliente tem múltiplas manutenções em um período curto. Considere uma visita técnica mais abrangente.';
  
  const actionButtons = document.createElement('div');
  actionButtons.className = 'flex gap-2';
  
  const filterBtn = document.createElement('button');
  filterBtn.className = 'btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft';
  filterBtn.textContent = 'Filtrar este cliente';
  filterBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fCliente.value = alert.cliente;
    applyFilters();
    showPage('dashboard');
  });
  
  const drillBtn = document.createElement('button');
  drillBtn.className = 'btn px-3 py-1.5 rounded-xl bg-white text-sm shadowSoft';
  drillBtn.textContent = 'Ver drill-down';
  drillBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    openDrill('cliente', alert.cliente);
  });
  
  actionButtons.appendChild(filterBtn);
  actionButtons.appendChild(drillBtn);
  
  actionsDiv.appendChild(infoText);
  actionsDiv.appendChild(actionButtons);
  details.appendChild(actionsDiv);
  
  alertDiv.appendChild(details);
  
  return alertDiv;
}

function toggleAlertDetails(index) {
  const details = el(`alert-details-${index}`);
  const alertDiv = el(`alert-${index}`);
  
  if (details.classList.contains('open')) {
    details.classList.remove('open');
    alertDiv.classList.remove('alert-expanded');
  } else {
    // Fechar outros alertas abertos
    document.querySelectorAll('.alert-details.open').forEach(el => {
      el.classList.remove('open');
      el.closest('.card').classList.remove('alert-expanded');
    });
    
    details.classList.add('open');
    alertDiv.classList.add('alert-expanded');
  }
}

// FUNÇÃO PARA IMPRIMIR ALERTAS
function printAlerts() {
  if (alertsData.length === 0) {
    alert('Nenhum alerta para imprimir.');
    return;
  }
  
  const printableDiv = el('printableAlerts');
  printableDiv.innerHTML = '';
  
  // Criar conteúdo para impressão
  let printHTML = `
    <style>
      @media print {
        body { font-family: Arial, sans-serif; }
        .print-header { text-align: center; margin-bottom: 20px; }
        .print-title { font-size: 24px; font-weight: bold; }
        .print-subtitle { font-size: 14px; color: #666; }
        .print-date { font-size: 12px; margin-top: 10px; }
        .print-section { margin-bottom: 20px; }
        .print-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .print-table th { background-color: #f5f5f5; font-weight: bold; }
        .alert-high-row { background-color: #fef2f2; }
        .alert-medium-row { background-color: #fffbeb; }
        .alert-low-row { background-color: #eff6ff; }
        .severity-badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; }
        .severity-high { background-color: #fecaca; color: #991b1b; }
        .severity-medium { background-color: #fef3c7; color: #92400e; }
        .severity-low { background-color: #dbeafe; color: #1e40af; }
        .print-summary { display: flex; justify-content: space-between; margin: 20px 0; }
        .summary-item { text-align: center; }
        .summary-value { font-size: 24px; font-weight: bold; }
        .summary-label { font-size: 12px; color: #666; }
        .page-break { page-break-after: always; }
      }
    </style>
    
    <div class="print-header">
      <div class="print-title">Relatório de Alertas - Smart Conecta</div>
      <div class="print-subtitle">Clientes com múltiplas manutenções em período curto</div>
      <div class="print-date">Gerado em: ${new Date().toLocaleDateString('pt-BR')}</div>
    </div>
    
    <div class="print-summary">
      <div class="summary-item">
        <div class="summary-value">${alertsData.length}</div>
        <div class="summary-label">Total de Alertas</div>
      </div>
      <div class="summary-item">
        <div class="summary-value">${alertsData.filter(a => a.severity === 'high').length}</div>
        <div class="summary-label">Alta Criticidade</div>
      </div>
      <div class="summary-item">
        <div class="summary-value">${alertsData.filter(a => a.severity === 'medium').length}</div>
        <div class="summary-label">Média Criticidade</div>
      </div>
      <div class="summary-item">
        <div class="summary-value">${alertsData.filter(a => a.severity === 'low').length}</div>
        <div class="summary-label">Baixa Criticidade</div>
      </div>
    </div>
    
    <div class="print-section">
      <h3>Lista de Alertas (${alertsData.length})</h3>
      <table class="print-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Criticidade</th>
            <th>Total Manutenções</th>
            <th>Máx. em ${alertDias.value} dias</th>
            <th>Primeira Data</th>
            <th>Equipamentos</th>
            <th>Técnicos</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  // Adicionar cada alerta
  alertsData.forEach(alert => {
    const severityClass = `severity-${alert.severity}`;
    const severityText = alert.severity === 'high' ? 'ALTA' : 
                        alert.severity === 'medium' ? 'MÉDIA' : 'BAIXA';
    
    printHTML += `
      <tr class="alert-${alert.severity}-row">
        <td>${escapeHtml(alert.cliente)}</td>
        <td><span class="severity-badge ${severityClass}">${severityText}</span></td>
        <td>${alert.totalManut}</td>
        <td>${alert.maxInWindow}</td>
        <td>${alert.windowStart || 'N/A'}</td>
        <td>${alert.equipamentos.length > 0 ? alert.equipamentos.join(', ') : 'Nenhum'}</td>
        <td>${alert.tecnicos.length > 0 ? alert.tecnicos.join(', ') : 'Nenhum'}</td>
      </tr>
    `;
  });
  
  printHTML += `
        </tbody>
      </table>
    </div>
    
    <div class="print-section">
      <h3>Detalhes por Cliente</h3>
  `;
  
  // Adicionar detalhes de cada cliente
  alertsData.forEach((alert, index) => {
    const severityText = alert.severity === 'high' ? 'ALTA' : 
                        alert.severity === 'medium' ? 'MÉDIA' : 'BAIXA';
    
    printHTML += `
      <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-left: 4px solid ${
        alert.severity === 'high' ? '#ef4444' : 
        alert.severity === 'medium' ? '#f59e0b' : '#3b82f6'
      };">
        <h4 style="margin: 0 0 5px 0;">${escapeHtml(alert.cliente)} - <span style="color: ${
          alert.severity === 'high' ? '#ef4444' : 
          alert.severity === 'medium' ? '#f59e0b' : '#3b82f6'
        };">${severityText}</span></h4>
        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
          ${alert.totalManut} manutenções no total • 
          ${alert.maxInWindow} manutenções em ${alert.windowDays} dias
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
          <div>
            <strong>Equipamentos:</strong><br>
            ${alert.equipamentos.length > 0 ? alert.equipamentos.map(e => `• ${escapeHtml(e)}`).join('<br>') : 'Nenhum'}
          </div>
          <div>
            <strong>Técnicos:</strong><br>
            ${alert.tecnicos.length > 0 ? alert.tecnicos.map(t => `• ${escapeHtml(t)}`).join('<br>') : 'Nenhum'}
          </div>
          <div>
            <strong>Motivos comuns:</strong><br>
            ${alert.topMotivos.length > 0 ? alert.topMotivos.map(([m, c]) => `• ${escapeHtml(m)} (${c})`).join('<br>') : 'Nenhum'}
          </div>
        </div>
        
        <div style="font-size: 11px;">
          <strong>Primeiros 5 registros:</strong>
          <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
            <thead>
              <tr style="background-color: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 3px;">Data</th>
                <th style="border: 1px solid #ddd; padding: 3px;">Chamado</th>
                <th style="border: 1px solid #ddd; padding: 3px;">Técnico</th>
                <th style="border: 1px solid #ddd; padding: 3px;">Acrésc.</th>
                <th style="border: 1px solid #ddd; padding: 3px;">Motivo</th>
              </tr>
            </thead>
            <tbody>
  `;
    
    // Adicionar primeiros 5 registros
    const firstRecords = alert.records.slice(0, 5);
    firstRecords.forEach(record => {
      printHTML += `
        <tr>
          <td style="border: 1px solid #ddd; padding: 3px;">${record.data || ''}</td>
          <td style="border: 1px solid #ddd; padding: 3px;">${escapeHtml(record.chamado)}</td>
          <td style="border: 1px solid #ddd; padding: 3px;">${escapeHtml(record.tecnico)}</td>
          <td style="border: 1px solid #ddd; padding: 3px;">${record.acrescimo || 0}</td>
          <td style="border: 1px solid #ddd; padding: 3px;">${escapeHtml(record.motivo.substring(0, 50))}${record.motivo.length > 50 ? '...' : ''}</td>
        </tr>
      `;
    });
    
    printHTML += `
            </tbody>
          </table>
          ${alert.records.length > 5 ? `<div style="font-size: 9px; text-align: right; margin-top: 3px;">... e mais ${alert.records.length - 5} registros</div>` : ''}
        </div>
      </div>
    `;
    
    // Adicionar quebra de página a cada 3 alertas (exceto o último)
    if ((index + 1) % 3 === 0 && index !== alertsData.length - 1) {
      printHTML += '<div class="page-break"></div>';
    }
  });
  
  printHTML += `
    </div>
    
    <div class="print-section" style="page-break-before: always;">
      <h3>Resumo Executivo</h3>
      <ul style="font-size: 12px;">
        <li>Total de clientes com alertas: ${alertsData.length}</li>
        <li>Clientes com alta criticidade: ${alertsData.filter(a => a.severity === 'high').length}</li>
        <li>Período de análise: ${alertDias.value} dias</li>
        <li>Critério mínimo: ${alertMinManut.value} manutenções no período</li>
        <li>Data de geração: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}</li>
      </ul>
      <div style="font-size: 11px; color: #666; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
        <strong>Recomendações:</strong>
        <ol style="margin-top: 5px;">
          <li>Clientes com ALTA criticidade devem receber visita técnica prioritária</li>
          <li>Verificar equipamentos problemáticos para possível substituição</li>
          <li>Acompanhar técnicos que atenderam múltiplas manutenções</li>
          <li>Analisar padrões comuns nos motivos dos chamados</li>
        </ol>
      </div>
    </div>
  `;
  
  printableDiv.innerHTML = printHTML;
  
  // Abrir janela de impressão
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Relatório de Alertas - Smart Conecta</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
      </head>
      <body>
        ${printableDiv.innerHTML}
        <script>
          window.onload = function() {
            window.print();
            setTimeout(function() {
              window.close();
            }, 1000);
          };
        <\/script>
      </body>
    </html>
  `);
  printWindow.document.close();
}

/* =========================
   ANÁLISE DE ACRÉSCIMOS
========================= */
function analyzeAcrescimos() {
  const windowDays = Math.max(1, toInt(acrescWindowDays.value));
  const tipoFiltro = acrescTipo.value.trim();
  const clienteFiltro = acrescCliente.value.trim().toLowerCase();
  
  acrescPeriodLabel.textContent = `${windowDays} dias`;
  
  // Obter registros com acréscimo
  const recordsWithAcresc = filtered.filter(r => (r.acrescimo || 0) > 0);
  
  if (recordsWithAcresc.length === 0) {
    acrescSummary.innerHTML = `
      <div class="card rounded-2xl p-4 bg-white shadowMedium">
        <div class="text-xs muted">Acréscimos encontrados</div>
        <div class="text-2xl font-semibold mono">0</div>
        <div class="text-xs muted">Nenhum acréscimo no período</div>
      </div>
      <div class="card rounded-2xl p-4 bg-white shadowMedium">
        <div class="text-xs muted">Reincidência pós-acréscimo</div>
        <div class="text-2xl font-semibold mono">0</div>
        <div class="text-xs muted">Nenhum caso detectado</div>
      </div>
      <div class="card rounded-2xl p-4 bg-white shadowMedium">
        <div class="text-xs muted">Clientes com reincidência</div>
        <div class="text-2xl font-semibold mono">0</div>
        <div class="text-xs muted">Nenhum cliente</div>
      </div>
      <div class="card rounded-2xl p-4 bg-white shadowMedium">
        <div class="text-xs muted">Taxa de reincidência</div>
        <div class="text-2xl font-semibold mono">0%</div>
        <div class="text-xs muted">Sem dados para análise</div>
      </div>
    `;
    
    acrescTableBody.innerHTML = `
      <tr><td colspan="8" class="p-4 text-center muted">Nenhum acréscimo encontrado no período atual.</td></tr>
    `;
    return;
  }
  
  // Agrupar por cliente
  const byClient = new Map();
  recordsWithAcresc.forEach(r => {
    const key = r.cliente || "(vazio)";
    if (!byClient.has(key)) byClient.set(key, []);
    byClient.get(key).push(r);
  });
  
  const results = [];
  const clientesComReincidencia = new Set();
  
  // Analisar cada cliente
  for (const [cliente, records] of byClient.entries()) {
    if (clienteFiltro && cliente.toLowerCase().indexOf(clienteFiltro) === -1) continue;
    
    // Ordenar por data
    const sorted = records.filter(r => r.data).sort((a, b) => a.data.localeCompare(b.data));
    
    if (sorted.length === 0) continue;
    
    // Para cada registro com acréscimo, procurar próximo chamado dentro da janela
    for (let i = 0; i < sorted.length; i++) {
      const current = sorted[i];
      
      // Buscar próximo chamado para este cliente (pode ser qualquer tipo, ou filtrado por tipo)
      const nextRecords = filtered.filter(r => 
        (r.cliente || "(vazio)") === cliente &&
        r.data && r.data > current.data &&
        (!tipoFiltro || r.tipo === tipoFiltro) &&
        r.chamado !== current.chamado // Não é o mesmo chamado
      );
      
      if (nextRecords.length === 0) continue;
      
      // Ordenar por data e pegar o mais próximo
      const nextRecordsSorted = nextRecords.sort((a, b) => a.data.localeCompare(b.data));
      const nextRecord = nextRecordsSorted[0];
      
      const daysDiff = daysBetween(current.data, nextRecord.data);
      
      if (daysDiff !== null && daysDiff <= windowDays) {
        results.push({
          cliente,
          dataAcresc: current.data,
          chamadoAcresc: current.chamado,
          tecnicoAcresc: current.tecnico,
          motivoAcresc: current.motivo,
          acrescimoValor: current.acrescimo || 0,
          dataProximo: nextRecord.data,
          chamadoProximo: nextRecord.chamado,
          tecnicoProximo: nextRecord.tecnico,
          tipoProximo: nextRecord.tipo,
          motivoProximo: nextRecord.motivo,
          diasDiferenca: daysDiff
        });
        
        clientesComReincidencia.add(cliente);
      }
    }
  }
  
  // Ordenar por diferença de dias (menor primeiro)
  results.sort((a, b) => a.diasDiferenca - b.diasDiferenca);
  
  // Atualizar KPIs
  const totalAcresc = recordsWithAcresc.length;
  const totalReinc = results.length;
  const clientesReinc = clientesComReincidencia.size;
  const taxaReinc = totalAcresc > 0 ? Math.round((totalReinc / totalAcresc) * 100) : 0;
  
  acrescSummary.innerHTML = `
    <div class="card rounded-2xl p-4 bg-white shadowMedium">
      <div class="text-xs muted">Acréscimos encontrados</div>
      <div class="text-2xl font-semibold mono">${totalAcresc}</div>
      <div class="text-xs muted">${windowDays} dias de análise</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white shadowMedium">
      <div class="text-xs muted">Reincidência pós-acréscimo</div>
      <div class="text-2xl font-semibold mono">${totalReinc}</div>
      <div class="text-xs muted">Casos detectados</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white shadowMedium">
      <div class="text-xs muted">Clientes com reincidência</div>
      <div class="text-2xl font-semibold mono">${clientesReinc}</div>
      <div class="text-xs muted">Clientes únicos</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white shadowMedium">
      <div class="text-xs muted">Taxa de reincidência</div>
      <div class="text-2xl font-semibold mono">${taxaReinc}%</div>
      <div class="text-xs muted">Do total de acréscimos</div>
    </div>
  `;
  
  // Atualizar tabela
  acrescTableBody.innerHTML = '';
  
  if (results.length === 0) {
    acrescTableBody.innerHTML = `
      <tr><td colspan="8" class="p-4 text-center muted">Nenhum caso de reincidência pós-acréscimo encontrado com os critérios atuais.</td></tr>
    `;
    return;
  }
  
  results.forEach(result => {
    const tr = document.createElement('tr');
    tr.className = 'border-t hover:bg-slate-50';
    
    const diasClass = result.diasDiferenca <= 3 ? 'text-red-600 font-bold' : 
                      result.diasDiferenca <= 7 ? 'text-orange-600 font-semibold' : 
                      'text-blue-600';
    
    tr.innerHTML = `
      <td class="p-2">${escapeHtml(result.cliente)}</td>
      <td class="p-2 mono">${result.dataAcresc}</td>
      <td class="p-2 mono">${escapeHtml(result.chamadoAcresc)}<br><span class="text-xs muted">${escapeHtml(result.tecnicoAcresc)}</span></td>
      <td class="p-2 mono">${escapeHtml(result.chamadoProximo)}<br><span class="text-xs muted">${escapeHtml(result.tecnicoProximo)}</span></td>
      <td class="p-2 mono ${diasClass}">${result.diasDiferenca} dias</td>
      <td class="p-2">${escapeHtml(result.tipoProximo)}</td>
      <td class="p-2 text-xs">${escapeHtml(result.motivoProximo)}</td>
      <td class="p-2">
        <button class="btn px-2 py-1 rounded-lg bg-white text-xs shadowSoft" onclick="drillToRegistro('${escapeHtml(result.cliente)}', '${result.dataAcresc}')">
          Detalhes
        </button>
      </td>
    `;
    
    acrescTableBody.appendChild(tr);
  });
}

// Função para drill-down a partir da tabela de acréscimos
window.drillToRegistro = function(cliente, data) {
  fCliente.value = cliente;
  fDe.value = data;
  // Calcular data final (7 dias após)
  const dataObj = new Date(data + 'T00:00:00Z');
  dataObj.setDate(dataObj.getDate() + 7);
  const dataFim = dataObj.toISOString().slice(0, 10);
  fAte.value = dataFim;
  applyFilters();
  showPage('registros');
};

/* =========================
   UI por módulo
========================= */
function applyModuleUI(){
  const mod = moduleSel.value;
  if (mod === "rh") wrapCliente.classList.add("hidden");
  else wrapCliente.classList.remove("hidden");

  if (mod === "rh") wrapEquip.classList.add("hidden");
  else wrapEquip.classList.remove("hidden");
}

/* =========================
   FILTROS
========================= */
function applyFilters(){
  const mod = moduleSel.value;
  const base = fBase.value.trim();
  const c = (mod==="rh") ? "" : fCliente.value.trim();
  const t = fTecnico.value.trim();
  const tp= fTipo.value.trim();
  const eq= (mod==="rh") ? "" : fEquip.value.trim();
  const de= fDe.value ? fDe.value : "";
  const ate= fAte.value ? fAte.value : "";
  const s = fSearch.value.trim().toLowerCase();

  filtered = rawRecords.filter(r=>{
    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (tp && r.tipo !== tp) return false;

    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;

    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }

    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  page = 1;
  fillMonthsCheckboxes();
  renderAll();
  renderAlerts();
  analyzeAcrescimos();
}

/* =========================
   COMPARAÇÃO MENSAL - NOVA FUNCIONALIDADE
========================= */
function fillMonthsCheckboxes() {
  const months = monthsAvailableFromFiltered();
  monthsCheckboxContainer.innerHTML = '';
  
  if (months.length === 0) {
    monthsCheckboxContainer.innerHTML = '<div class="text-sm muted p-3">Nenhum mês disponível com os filtros atuais</div>';
    return;
  }
  
  months.forEach(month => {
    const checkboxId = `month-${month}`;
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2';
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" value="${month}" class="rounded border-slate-300">
      <label for="${checkboxId}" class="text-sm cursor-pointer">${month}</label>
    `;
    
    const checkbox = div.querySelector('input');
    checkbox.checked = selectedMonths.has(month);
    checkbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        selectedMonths.add(month);
      } else {
        selectedMonths.delete(month);
      }
      renderMonthlyComparison();
    });
    
    monthsCheckboxContainer.appendChild(div);
  });
}

function monthsAvailableFromFiltered() {
  return uniqSorted(filtered.map(r => r.month).filter(Boolean));
}

function renderMonthlyComparison() {
  const months = Array.from(selectedMonths).sort();
  
  // Mostrar/ocultar seções baseado no número de meses selecionados
  if (months.length === 0) {
    monthDetailedAnalysis.classList.add('hidden');
    monthlyKPIs.innerHTML = '<div class="text-sm muted p-3">Selecione pelo menos um mês para visualizar a análise</div>';
    comparisonCharts.classList.add('hidden');
    return;
  }
  
  if (months.length === 1) {
    // Mostrar análise detalhada de um único mês
    renderSingleMonthDetailedAnalysis(months[0]);
    comparisonCharts.classList.add('hidden');
    monthlyKPIs.innerHTML = '';
  } else {
    // Mostrar comparação entre múltiplos meses
    monthDetailedAnalysis.classList.add('hidden');
    renderMultipleMonthsComparison(months);
    comparisonCharts.classList.remove('hidden');
  }
}

function renderSingleMonthDetailedAnalysis(month) {
  const monthRecords = filtered.filter(r => r.month === month);
  
  // 1. Qual cliente do mês teve mais manutenção?
  const manutencaoRecords = monthRecords.filter(r => r.tipo === "Manutenção");
  const clienteManutCount = groupCount(manutencaoRecords, r => r.cliente || "(vazio)");
  const topClienteManut = topN(clienteManutCount, 1)[0] || ["Nenhum", 0];
  
  // 2. Qual cliente do mês teve mais montagem?
  const montagemRecords = monthRecords.filter(r => r.tipo === "Montagem");
  const clienteMontCount = groupCount(montagemRecords, r => r.cliente || "(vazio)");
  const topClienteMont = topN(clienteMontCount, 1)[0] || ["Nenhum", 0];
  
  // 3. Qual equipamento do mês X deu mais problemas?
  // Consideramos "problemas" como manutenções em equipamentos
  const equipProblemMap = new Map();
  manutencaoRecords.forEach(r => {
    for (const col of equipColumns) {
      const qty = toInt((r._raw||{})[col]);
      if (qty > 0) {
        equipProblemMap.set(col, (equipProblemMap.get(col) || 0) + qty);
      }
    }
  });
  const topEquipProblem = topN(equipProblemMap, 5);
  
  // 4. Total do mês e comparação com mês anterior (se disponível)
  const allMonths = monthsAvailableFromFiltered();
  const monthIndex = allMonths.indexOf(month);
  let trendInfo = { total: monthRecords.length, diff: null, pct: null };
  
  if (monthIndex > 0) {
    const prevMonth = allMonths[monthIndex - 1];
    const prevMonthRecords = filtered.filter(r => r.month === prevMonth);
    const prevTotal = prevMonthRecords.length;
    const diff = monthRecords.length - prevTotal;
    const pct = prevTotal > 0 ? ((diff / prevTotal) * 100).toFixed(1) : null;
    
    trendInfo = {
      total: monthRecords.length,
      diff,
      pct,
      prevMonth,
      prevTotal
    };
  }
  
  // Renderizar análise detalhada
  monthDetailedAnalysis.classList.remove('hidden');
  monthDetailedAnalysis.innerHTML = `
    <div class="card rounded-2xl p-4 bg-white month-analysis shadowMedium">
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="text-lg font-semibold">Análise Detalhada - ${month}</div>
          <div class="text-xs muted">${monthRecords.length} registros no mês</div>
        </div>
        <div class="chip rounded-xl px-3 py-2 bg-slate-50 text-xs shadowSoft">
          <span class="muted">Tendência:</span> 
          <span class="mono font-semibold ${trendInfo.diff > 0 ? 'trend-up' : trendInfo.diff < 0 ? 'trend-down' : 'trend-neutral'}">
            ${trendInfo.diff !== null ? `${trendInfo.diff > 0 ? '+' : ''}${trendInfo.diff} (${trendInfo.pct}%)` : 'N/A'}
          </span>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Cliente com mais manutenção -->
        <div class="card rounded-xl p-3 bg-slate-50 shadowSoft">
          <div class="text-xs muted mb-1">Cliente com mais manutenção</div>
          <div class="text-lg font-semibold truncate">${escapeHtml(topClienteManut[0])}</div>
          <div class="text-sm mono">${topClienteManut[1]} manutenções</div>
          <div class="text-xs muted mt-1">de ${manutencaoRecords.length} total</div>
        </div>
        
        <!-- Cliente com mais montagem -->
        <div class="card rounded-xl p-3 bg-slate-50 shadowSoft">
          <div class="text-xs muted mb-1">Cliente com mais montagem</div>
          <div class="text-lg font-semibold truncate">${escapeHtml(topClienteMont[0])}</div>
          <div class="text-sm mono">${topClienteMont[1]} montagens</div>
          <div class="text-xs muted mt-1">de ${montagemRecords.length} total</div>
        </div>
        
        <!-- Total do mês -->
        <div class="card rounded-xl p-3 bg-slate-50 shadowSoft">
          <div class="text-xs muted mb-1">Total do mês</div>
          <div class="text-2xl font-semibold mono">${monthRecords.length}</div>
          <div class="text-xs muted mt-1">
            ${trendInfo.prevMonth ? 
              `vs ${trendInfo.prevMonth}: ${trendInfo.prevTotal}` : 
              'Primeiro mês disponível'}
          </div>
        </div>
      </div>
      
      <!-- Equipamentos problemáticos -->
      <div class="card rounded-xl p-3 bg-white shadowSoft">
        <div class="text-sm font-semibold mb-2">Equipamentos com mais problemas (manutenções)</div>
        <div class="text-xs muted mb-3">Top 5 equipamentos por quantidade de manutenções no mês</div>
        
        <div class="overflow-auto border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr class="text-left">
                <th class="p-2">Equipamento</th>
                <th class="p-2">Manutenções</th>
                <th class="p-2">% do total</th>
              </tr>
            </thead>
            <tbody>
              ${topEquipProblem.length > 0 ? 
                topEquipProblem.map(([equip, count]) => `
                  <tr class="border-t hover:bg-slate-50">
                    <td class="p-2">${escapeHtml(equip)}</td>
                    <td class="p-2 mono font-semibold">${count}</td>
                    <td class="p-2 mono">${manutencaoRecords.length > 0 ? ((count / manutencaoRecords.length * 100).toFixed(1) + '%') : '0%'}</td>
                  </tr>
                `).join('') : 
                `<tr class="border-t"><td class="p-2 muted" colspan="3">Nenhuma manutenção registrada neste mês</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Distribuição por tipo -->
      <div class="mt-4 card rounded-xl p-3 bg-white shadowSoft">
        <div class="text-sm font-semibold mb-2">Distribuição por tipo de serviço</div>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
          ${VALID_TIPOS.map(tipo => {
            const count = monthRecords.filter(r => r.tipo === tipo).length;
            const pct = monthRecords.length > 0 ? ((count / monthRecords.length) * 100).toFixed(1) : 0;
            return `
              <div class="card rounded-lg p-2 bg-slate-50 text-center">
                <div class="text-xs muted">${tipo}</div>
                <div class="text-lg font-semibold mono">${count}</div>
                <div class="text-xs muted">${pct}%</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderMultipleMonthsComparison(months) {
  // Dados por mês
  const monthlyData = months.map(month => {
    const monthRecords = filtered.filter(r => r.month === month && VALID_TIPOS.includes(r.tipo));
    
    // Contagem por tipo
    const counts = {};
    VALID_TIPOS.forEach(tipo => {
      counts[tipo] = monthRecords.filter(r => r.tipo === tipo).length;
    });
    
    // Total válido (apenas tipos válidos)
    const totalValid = monthRecords.length;
    
    // Acréscimos
    const acrescimos = monthRecords.reduce((sum, r) => sum + (r.acrescimo || 0), 0);
    
    return {
      month,
      counts,
      totalValid,
      acrescimos
    };
  });
  
  // Render KPIs por mês
  renderMonthlyKPIs(monthlyData);
  
  // Render gráficos
  renderComparisonCharts(monthlyData);
  
  // Render tabela comparativa com análise de tendência
  renderComparisonTableWithTrend(monthlyData);
}

function renderMonthlyKPIs(monthlyData) {
  monthlyKPIs.innerHTML = '';
  
  const container = document.createElement('div');
  container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3';
  
  monthlyData.forEach(data => {
    const div = document.createElement('div');
    div.className = 'card rounded-2xl p-4 bg-white shadowMedium';
    div.innerHTML = `
      <div class="text-sm font-semibold">${data.month}</div>
      <div class="mt-2 space-y-1 text-sm">
        <div class="flex justify-between">
          <span class="muted">Total:</span>
          <span class="mono font-semibold">${data.totalValid}</span>
        </div>
        <div class="flex justify-between">
          <span class="muted">Acréscimos:</span>
          <span class="mono font-semibold">${data.acrescimos}</span>
        </div>
        ${VALID_TIPOS.map(tipo => `
          <div class="flex justify-between">
            <span class="muted">${tipo}:</span>
            <span class="mono">${data.counts[tipo]}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(div);
  });
  
  monthlyKPIs.appendChild(container);
}

function renderComparisonCharts(monthlyData) {
  const months = monthlyData.map(d => d.month);
  
  // Gráfico 1: Comparação por tipo (agrupado)
  const datasets1 = VALID_TIPOS.map((tipo, idx) => {
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    return {
      label: tipo,
      data: monthlyData.map(d => d.counts[tipo]),
      backgroundColor: colors[idx % colors.length],
      borderColor: colors[idx % colors.length],
      borderWidth: 1
    };
  });
  
  destroyIfExists(compareChart1);
  compareChart1 = new Chart(el("compareChart1"), {
    type: 'bar',
    data: {
      labels: months,
      datasets: datasets1
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
  el("compareMeta1").textContent = `${months.length} mês(es) selecionado(s)`;
  
  // Gráfico 2: Evolução total mensal (linha)
  const totalData = monthlyData.map(d => d.totalValid);
  
  destroyIfExists(compareChart2);
  compareChart2 = new Chart(el("compareChart2"), {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Total de serviços',
        data: totalData,
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderColor: '#3b82f6',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
  el("compareMeta2").textContent = `${months.length} mês(es) selecionado(s)`;
}

function renderComparisonTableWithTrend(monthlyData) {
  const months = monthlyData.map(d => d.month);
  
  // Cabeçalho
  const thead = document.querySelector('#compareTableBody').closest('table').querySelector('thead tr');
  thead.innerHTML = '<th class="p-2">Tipo</th>';
  months.forEach(month => {
    thead.innerHTML += `<th class="p-2">${month}</th>`;
  });
  thead.innerHTML += '<th class="p-2">Variação</th><th class="p-2">%</th>';
  
  // Corpo da tabela
  let tableHTML = '';
  
  // Calcular totais por mês
  const totalsByMonth = months.map(month => {
    const data = monthlyData.find(d => d.month === month);
    return data ? data.totalValid : 0;
  });
  
  // Linhas para cada tipo
  VALID_TIPOS.forEach(tipo => {
    const rowData = months.map(month => {
      const data = monthlyData.find(d => d.month === month);
      return data ? data.counts[tipo] || 0 : 0;
    });
    
    // Calcular variação
    const firstValue = rowData[0];
    const lastValue = rowData[rowData.length - 1];
    const variation = lastValue - firstValue;
    const variationPct = firstValue > 0 ? ((variation / firstValue) * 100).toFixed(1) : 'N/A';
    
    tableHTML += `
      <tr class="border-t hover:bg-slate-50">
        <td class="p-2 font-medium">${tipo}</td>
        ${rowData.map(val => `<td class="p-2 mono text-center">${val}</td>`).join('')}
        <td class="p-2 mono text-center ${variation > 0 ? 'trend-up' : variation < 0 ? 'trend-down' : ''}">
          ${variation > 0 ? '+' : ''}${variation}
        </td>
        <td class="p-2 mono text-center ${variation > 0 ? 'trend-up' : variation < 0 ? 'trend-down' : ''}">
          ${variationPct !== 'N/A' ? `${variationPct}%` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  // Linha de total com análise de tendência
  const firstTotal = totalsByMonth[0];
  const lastTotal = totalsByMonth[totalsByMonth.length - 1];
  const totalVariation = lastTotal - firstTotal;
  const totalVariationPct = firstTotal > 0 ? ((totalVariation / firstTotal) * 100).toFixed(1) : 'N/A';
  const totalRowData = totalsByMonth;
  const grandTotal = totalRowData.reduce((sum, val) => sum + val, 0);
  const avgPerMonth = (grandTotal / months.length).toFixed(1);
  
  tableHTML += `
    <tr class="border-t bg-slate-100">
      <td class="p-2 font-semibold">TOTAL</td>
      ${totalRowData.map(val => `<td class="p-2 mono font-semibold text-center">${val}</td>`).join('')}
      <td class="p-2 mono font-semibold text-center ${totalVariation > 0 ? 'trend-up' : totalVariation < 0 ? 'trend-down' : ''}">
        ${totalVariation > 0 ? '+' : ''}${totalVariation}
      </td>
      <td class="p-2 mono font-semibold text-center ${totalVariation > 0 ? 'trend-up' : totalVariation < 0 ? 'trend-down' : ''}">
        ${totalVariationPct !== 'N/A' ? `${totalVariationPct}%` : 'N/A'}
      </td>
    </tr>
    
    <tr class="border-t bg-blue-50">
      <td class="p-2 font-medium text-blue-800">ANÁLISE DE TENDÊNCIA</td>
      <td colspan="${months.length + 1}" class="p-2 text-sm text-blue-800">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <div>
            <span class="muted">Período:</span> ${months[0]} → ${months[months.length - 1]}
          </div>
          <div>
            <span class="muted">Variação total:</span> ${totalVariation > 0 ? '+' : ''}${totalVariation} (${totalVariationPct !== 'N/A' ? `${totalVariationPct}%` : 'N/A'})
          </div>
          <div>
            <span class="muted">Média/mês:</span> ${avgPerMonth}
          </div>
          <div>
            <span class="muted">Tendência:</span> 
            <span class="${totalVariation > 0 ? 'trend-up font-semibold' : totalVariation < 0 ? 'trend-down font-semibold' : 'trend-neutral'}">
              ${totalVariation > 0 ? '↗ Crescimento' : totalVariation < 0 ? '↘ Queda' : '➡ Estável'}
            </span>
          </div>
        </div>
      </td>
      <td class="p-2"></td>
    </tr>
  `;
  
  compareTableBody.innerHTML = tableHTML;
}

/* =========================
   KPIs + INSIGHTS
========================= */
function calcReinc(records){
  const win = Math.max(1, toInt(alertDias.value));
  const minCommon = Math.max(0, toInt(alertMinManut.value));

  const byClient = new Map();
  for (const r of records){
    const key = r.cliente || "(vazio)";
    if (!byClient.has(key)) byClient.set(key, []);
    byClient.get(key).push(r);
  }

  let reinc = 0, base=0;
  for (const arr of byClient.values()){
    const sorted = arr.filter(x=>x.data).sort((a,b)=>String(a.data).localeCompare(String(b.data)));
    for (let i=0;i<sorted.length;i++){
      base++;
      const cur = sorted[i];
      for (let j=i+1;j<sorted.length;j++){
        const nxt = sorted[j];
        const d = daysBetween(cur.data, nxt.data);
        if (d===null) continue;
        if (d>win) break;
        if (minCommon===0 || motivoSimilar(cur.motivo, nxt.motivo, minCommon)){
          reinc++; break;
        }
      }
    }
  }
  return {reinc, base, pct: base? Math.round((reinc/base)*100) : 0};
}

function sumEquip(records){
  let s=0;
  for (const r of records){
    for (const col of equipColumns){
      s += Math.max(0, toInt((r._raw||{})[col]));
    }
  }
  return s;
}

function avgChamadosPorDia(records){
  const byDay = groupCount(records, r=>r.data||"");
  const days = [...byDay.keys()].filter(Boolean).length;
  if (!days) return null;
  return records.length / days;
}

function currentMonth(records){
  const months = records.map(r=>r.month).filter(Boolean).sort();
  return months.length ? months[months.length-1] : "";
}

function trend7(records){
  const dates = records.map(r=>r.data).filter(Boolean).sort();
  if (!dates.length) return null;
  const max = dates[dates.length-1];
  const end = new Date(max+"T00:00:00Z");
  const d7a = new Date(end.getTime() - 6*86400000);
  const d7b = new Date(end.getTime() - 13*86400000);
  const iso = d=>d.toISOString().slice(0,10);

  const a0 = iso(d7a), a1 = max;
  const b0 = iso(d7b), b1 = iso(new Date(d7a.getTime()-86400000));

  const countRange = (x0,x1)=>records.filter(r=>r.data && r.data>=x0 && r.data<=x1).length;
  const A = countRange(a0,a1);
  const B = countRange(b0,b1);
  const pct = B ? Math.round(((A-B)/B)*100) : null;
  return {A,B,pct,range:`${a0}→${a1}`};
}

function isoWeekKey(iso){
  const d = new Date(iso+"T00:00:00Z");
  const day = (d.getUTCDay()+6)%7; // 0=Mon
  d.setUTCDate(d.getUTCDate() - day + 3); // quinta
  const year = d.getUTCFullYear();
  const firstThu = new Date(Date.UTC(year,0,4));
  const firstDay = (firstThu.getUTCDay()+6)%7;
  firstThu.setUTCDate(firstThu.getUTCDate() - firstDay + 3);
  const week = 1 + Math.round((d - firstThu)/86400000/7);
  return `${year}-W${String(week).padStart(2,"0")}`;
}
function calcProdSemana(records){
  const byW = new Map();
  for (const r of records){
    if (!r.data) continue;
    const w = isoWeekKey(r.data);
    byW.set(w, (byW.get(w)||0)+1);
  }
  const weeks = [...byW.values()];
  if (!weeks.length) return null;
  return weeks.reduce((a,b)=>a+b,0)/weeks.length;
}

function renderKPIs(){
  const mod = moduleSel.value;

  const total = filtered.length;
  const acresc = filtered.reduce((a,r)=>a+(r.acrescimo||0),0);
  const equipS = sumEquip(filtered);
  const reinc = calcReinc(filtered);
  const prod = avgChamadosPorDia(filtered);

  const tr = trend7(filtered);
  const cm = currentMonth(filtered);

  currentMonthLabel.textContent = cm || "—";
  trendLabel.textContent = tr ? (tr.pct===null ? `${tr.A}` : `${tr.pct}%`) : "—";

  const cards = [];
  if (mod === "operacoes"){
    const mix = groupCount(filtered.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
    const topTipo = topN(mix, 1)[0] ? `${topN(mix,1)[0][0]} (${topN(mix,1)[0][1]})` : "—";

    const daySet = new Set(filtered.map(r=>r.data).filter(Boolean));
    const carSet = new Set(filtered.map(r=>r.carro).filter(Boolean));
    const daysWithData = daySet.size || 0;
    const cars = carSet.size || 0;

    const avgPerDay = daysWithData ? (total / daysWithData) : null;
    const estMonth = avgPerDay ? (avgPerDay * 30.42) : null;

    cards.push({t:"Chamados", v: total, s:"no recorte"});
    cards.push({t:"Maior fatia", v: topTipo, s:"mix de tipo"});
    cards.push({t:"Média (cham./dia)", v: (avgPerDay===null?"—":avgPerDay.toFixed(2)), s: `${daysWithData||"—"} dia(s) com dados`});
    cards.push({t:"Média (cham./mês)", v: (estMonth===null?"—":estMonth.toFixed(0)), s:"estimativa via média/dia"});
    cards.push({t:"Acréscimos", v: acresc, s:"soma do recorte"});
    cards.push({t:"Equip (qty)", v: equipS, s:"soma nas colunas detectadas"});
  } else {
    const techSet = new Set(filtered.map(r=>r.tecnico).filter(Boolean));
    const techCount = techSet.size;

    const tech = fTecnico.value.trim();
    const recTech = tech ? filtered.filter(r=>r.tecnico===tech) : filtered;
    const prodDia = avgChamadosPorDia(recTech);
    const prodSemana = calcProdSemana(recTech);

    cards.push({t:"Técnicos (no recorte)", v: techCount || "—", s:"únicos"});
    cards.push({t:"Chamados", v: total, s:"no recorte"});
    cards.push({t:"Prod/dia", v: prodDia===null ? "—" : prodDia.toFixed(2), s: tech ? `técnico: ${tech}` : "base atual"});
    cards.push({t:"Prod/semana", v: prodSemana===null ? "—" : prodSemana.toFixed(2), s:"média (ISO week)"});
  }

  kpiGrid.innerHTML = "";
  for (const c of cards){
    const div = document.createElement("div");
    div.className = "card rounded-2xl p-4 bg-white shadowMedium";
    div.innerHTML = `
      <div class="text-xs muted">${escapeHtml(c.t)}</div>
      <div class="text-2xl font-semibold mono kpiVal">${escapeHtml(c.v)}</div>
      <div class="text-xs muted">${escapeHtml(c.s)}</div>
    `;
    kpiGrid.appendChild(div);
  }
}

/* =========================
   EQUIP por TIPO DOMINANTE
========================= */
function equipTotalsByTipo(records, tipo){
  const m = new Map();
  for (const r of records){
    if (r.tipo !== tipo) continue;
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) m.set(col, (m.get(col)||0)+v);
    }
  }
  return m;
}

function renderDominantEquip(){
  const mod = moduleSel.value;
  if (mod !== "operacoes"){
    opDominantEquip.classList.add("hidden");
    opDominantEquip.innerHTML = "";
    return;
  }

  const baseFilteredNoTipo = rawRecords.filter(r=>{
    const base = fBase.value.trim();
    const c = fCliente.value.trim();
    const t = fTecnico.value.trim();
    const eq= fEquip.value.trim();
    const de= fDe.value ? fDe.value : "";
    const ate= fAte.value ? fAte.value : "";
    const s = fSearch.value.trim().toLowerCase();

    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;
    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }
    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  const mix = groupCount(baseFilteredNoTipo.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
  const top = topN(mix, 1)[0];
  if (!top){
    opDominantEquip.classList.add("hidden");
    opDominantEquip.innerHTML = "";
    return;
  }

  const dominantTipo = top[0];
  const totals = equipTotalsByTipo(baseFilteredNoTipo, dominantTipo);
  const topEquip = topN(totals, 8);

  const leader = topEquip[0] ? `${topEquip[0][0]} (× ${topEquip[0][1]})` : "—";

  opDominantEquip.classList.remove("hidden");
  opDominantEquip.innerHTML = `
    <div class="flex items-start justify-between flex-wrap gap-2">
      <div>
        <div class="text-lg font-semibold">Pergunta de reunião: "A maior fatia foi ${escapeHtml(dominantTipo)}. Qual equipamento liderou?"</div>
        <div class="text-xs muted">Ranking por qty nas colunas de equipamento (no recorte atual, ignorando o filtro de tipo).</div>
      </div>
      <div class="chip rounded-xl px-3 py-2 bg-slate-50 text-xs shadowSoft">
        <span class="muted">Líder:</span> <span class="mono font-semibold">${escapeHtml(leader)}</span>
      </div>
    </div>

    <div class="mt-3 overflow-auto border rounded-2xl shadowSoft">
      <table class="min-w-full text-sm bg-white">
        <thead class="bg-slate-100">
          <tr class="text-left">
            <th class="p-2">Equipamento</th>
            <th class="p-2">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          ${topEquip.map(([k,v])=>`
            <tr class="border-t hover:bg-slate-50">
              <td class="p-2">${escapeHtml(k)}</td>
              <td class="p-2 mono font-semibold">${v}</td>
            </tr>
          `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="2">Sem dados de equipamento nesse tipo.</td></tr>`}
        </tbody>
      </table>
    </div>
  `;
}

/* =========================
   SAÚDE POR EQUIPAMENTO
========================= */
function renderEquipHealth(){
  const mod = moduleSel.value;
  if (mod !== "operacoes"){
    equipHealthWrap.classList.add("hidden");
    equipHealthWrap.innerHTML = "";
    return;
  }

  if (!equipColumns.length){
    equipHealthWrap.classList.remove("hidden");
    equipHealthWrap.innerHTML = `
      <div class="text-lg font-semibold">Saúde por equipamento</div>
      <div class="text-xs muted mt-1">Não encontrei colunas de equipamento (somente colunas numéricas fora dos campos fixos).</div>
    `;
    return;
  }

  const selected = healthSelectedCol && equipColumns.includes(healthSelectedCol)
    ? healthSelectedCol
    : equipColumns[0];

  const win = Math.max(1, toInt(healthWindowDays.value));

  const baseRec = rawRecords.filter(r=>{
    const base = fBase.value.trim();
    const c = fCliente.value.trim();
    const t = fTecnico.value.trim();
    const eq= fEquip.value.trim();
    const de= fDe.value ? fDe.value : "";
    const ate= fAte.value ? fAte.value : "";
    const s = fSearch.value.trim().toLowerCase();

    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;
    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }
    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  const maintMap = new Map();
  for (const col of equipColumns){
    let qty = 0;
    for (const r of baseRec){
      if (r.tipo !== "Manutenção") continue;
      qty += Math.max(0, toInt((r._raw||{})[col]));
    }
    if (qty>0) maintMap.set(col, qty);
  }
  const topMaint = topN(maintMap, 10);

  const maintTotal = maintMap.get(selected) || 0;

  let montCount = 0;
  for (const r of baseRec){
    if (r.tipo !== "Montagem") continue;
    const q = toInt((r._raw||{})[selected]);
    if (q>0) montCount += q;
  }

  const flagged = postDeliveryMaintenance(baseRec, selected, win);
  const flaggedCount = flagged.length;
  const pct = montCount ? Math.round((flaggedCount / montCount) * 100) : 0;

  const allMaintDates = [];
  for (const r of baseRec){
    if (!r.data) continue;
    if (r.tipo !== "Manutenção") continue;
    const q = toInt((r._raw||{})[selected]);
    if (q>0) allMaintDates.push(r.data);
  }
  allMaintDates.sort();
  let avgGapGlobal = null;
  if (allMaintDates.length >= 2){
    const gaps = [];
    for (let i=1;i<allMaintDates.length;i++){
      gaps.push(daysBetween(allMaintDates[i-1], allMaintDates[i]));
    }
    avgGapGlobal = Math.round(gaps.reduce((a,b)=>a+b,0)/gaps.length);
  }

  equipHealthWrap.classList.remove("hidden");
  equipHealthWrap.innerHTML = `
    <div class="flex items-start justify-between flex-wrap gap-3">
      <div>
        <div class="text-lg font-semibold">Saúde por equipamento (todos)</div>
        <div class="text-xs muted">
          Responde: "qual equipamento está dando manutenção com mais frequência?", "quanto tempo entre falhas (proxy)?", "entrega virou manutenção rápido?".
        </div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs muted">Equipamento:</span>
        <select id="healthEquipSel" class="btn px-3 py-2 rounded-xl bg-white text-sm shadowSoft">
          ${equipColumns.map(c=>`<option value="${escapeHtml(c)}" ${c===selected?"selected":""}>${escapeHtml(c)}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
      <div class="card rounded-2xl p-3 bg-slate-50 shadowSoft">
        <div class="text-xs muted">Manutenção (qty)</div>
        <div class="text-2xl font-semibold mono">${maintTotal}</div>
      </div>
      <div class="card rounded-2xl p-3 bg-slate-50 shadowSoft">
        <div class="text-xs muted">Gap médio (dias)</div>
        <div class="text-2xl font-semibold mono">${avgGapGlobal===null?"—":avgGapGlobal}</div>
      </div>
      <div class="card rounded-2xl p-3 bg-slate-50 shadowSoft">
        <div class="text-xs muted">Pós-montagem (até ${win}d)</div>
        <div class="text-2xl font-semibold mono">${flaggedCount}</div>
      </div>
      <div class="card rounded-xl p-3 bg-slate-50 shadowSoft">
        <div class="text-xs muted">% pós-montagem</div>
        <div class="text-2xl font-semibold mono">${montCount?`${pct}%`:"—"}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-3">
      <div class="card rounded-2xl p-3 bg-white shadowMedium">
        <div class="text-sm font-semibold">Top equipamentos por manutenção (qty)</div>
        <div class="text-xs muted">Base: recorte atual (filtros), tipo=Manutenção</div>
        <div class="mt-2 overflow-auto border rounded-2xl max-h-72 shadowSoft">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr class="text-left"><th class="p-2">Equipamento</th><th class="p-2">Qty</th></tr>
            </thead>
            <tbody>
              ${topMaint.map(([k,v])=>`
                <tr class="border-t hover:bg-slate-50">
                  <td class="p-2">${escapeHtml(k)}</td>
                  <td class="p-2 mono font-semibold">${v}</td>
                </tr>
              `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="2">Sem manutenção detectada no recorte.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-3 bg-white shadowMedium">
        <div class="text-sm font-semibold">Casos: Montagem → Manutenção (até ${win} dias)</div>
        <div class="text-xs muted">Chave: base + cliente + coluna de equipamento (sem serial/patrimônio).</div>
        <div class="mt-2 overflow-auto border rounded-2xl max-h-72 shadowSoft">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr class="text-left">
                <th class="p-2">Base</th>
                <th class="p-2">Cliente</th>
                <th class="p-2">Montagem</th>
                <th class="p-2">Manut.</th>
                <th class="p-2">Δ dias</th>
              </tr>
            </thead>
            <tbody>
              ${flagged.slice(0, 30).map(x=>`
                <tr class="border-t hover:bg-slate-50">
                  <td class="p-2">${escapeHtml(x.base)}</td>
                  <td class="p-2">${escapeHtml(x.cliente)}</td>
                  <td class="p-2 mono">${escapeHtml(x.montagem)}</td>
                  <td class="p-2 mono">${escapeHtml(x.manutencao)}</td>
                  <td class="p-2 mono font-semibold">${x.deltaDays}</td>
                </tr>
              `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="5">Nenhum caso detectado no recorte.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-3 text-xs muted">
      Nota técnica: isso é um <b>proxy</b> (mesmo cliente + mesma coluna/modelo). Para "mesmo equipamento físico", precisa de patrimônio/serial no XLSX.
    </div>
  `;

  const sel = el("healthEquipSel");
  sel.addEventListener("change", ()=>{
    healthSelectedCol = sel.value;
    renderEquipHealth();
  });
}

function postDeliveryMaintenance(records, equipCol, windowDays=14){
  const byKey = new Map();
  const keyFn = (r)=> `${r.base||""}||${r.cliente||"(vazio)"}||${equipCol}`;

  for (const r of records){
    if (!r.data) continue;
    const qty = toInt((r._raw||{})[equipCol]);
    if (!(qty > 0)) continue;
    if (r.tipo !== "Montagem" && r.tipo !== "Manutenção") continue;

    const k = keyFn(r);
    if (!byKey.has(k)) byKey.set(k, {cliente:r.cliente||"(vazio)", base:r.base||"", montagens:[], manut:[]});
    if (r.tipo === "Montagem") byKey.get(k).montagens.push(r.data);
    if (r.tipo === "Manutenção") byKey.get(k).manut.push(r.data);
  }

  const flagged = [];
  for (const obj of byKey.values()){
    obj.montagens.sort();
    obj.manut.sort();
    if (!obj.montagens.length || !obj.manut.length) continue;

    let j=0;
    for (const mDate of obj.montagens){
      while (j < obj.manut.length && obj.manut[j] < mDate) j++;
      if (j >= obj.manut.length) break;
      const delta = daysBetween(mDate, obj.manut[j]);
      if (delta !== null && delta >= 0 && delta <= windowDays){
        flagged.push({
          base: obj.base,
          cliente: obj.cliente,
          equip: equipCol,
          montagem: mDate,
          manutencao: obj.manut[j],
          deltaDays: delta
        });
      }
    }
  }
  flagged.sort((a,b)=>a.deltaDays - b.deltaDays);
  return flagged;
}

/* =========================
   GRÁFICOS
========================= */
function buildCharts(){
  const mod = moduleSel.value;

  // Chart 1: chamados por dia
  let baseForChart = filtered;
  if (mod === "rh" && fTecnico.value.trim()){
    baseForChart = filtered.filter(r=>r.tecnico===fTecnico.value.trim());
  }

  const byDay = groupCount(baseForChart, r=>r.data || "(sem data)");
  const dayEntries = [...byDay.entries()].sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
  const labelsDay = dayEntries.map(([k])=>k);
  const dataDay   = dayEntries.map(([,v])=>v);
  el("g1meta").textContent = `${labelsDay.length} dia(s)`;

  destroyIfExists(chart1);
  chart1 = new Chart(el("chart1"), {
    type:"line",
    data:{ labels: labelsDay, datasets:[{ label:"Chamados", data: dataDay, tension:0.25 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ x:{ticks:{maxRotation:0,autoSkip:true}}, y:{beginAtZero:true,ticks:{precision:0}} }
    }
  });

  // Chart 2: Mix de tipo
  const mix = groupCount(filtered.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
  const mixEntries = VALID_TIPOS.map(t=>[t, mix.get(t)||0]).filter(([,v])=>v>0);
  el("g2meta").textContent = `${mixEntries.reduce((a,[,v])=>a+v,0)} chamados`;

  destroyIfExists(chart2);
  chart2 = new Chart(el("chart2"), {
    type:"pie",
    data:{
      labels: mixEntries.map(([k])=>k),
      datasets:[{ label:"Mix", data: mixEntries.map(([,v])=>v) }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{
          display:true,
          position:"bottom",
          onClick: (e, item, legend)=>{
            const chart = legend.chart;
            chart.toggleDataVisibility(item.index);
            chart.update();

            const ds = chart.data.datasets[0];
            let visTotal = 0;
            for (let i=0;i<ds.data.length;i++){
              if (chart.getDataVisibility(i)) visTotal += Number(ds.data[i]||0);
            }
            el("g2meta").textContent = `${visTotal} chamados`;
          }
        }
      }
    }
  });

  // Chart 3: Operacional => Top clientes; RH => Top técnicos
  destroyIfExists(chart3);
  if (mod === "operacoes"){
    el("g3title").textContent = "Top clientes (volume)";
    const byClient = groupCount(filtered, r=>r.cliente || "(vazio)");
    const clientTop = topN(byClient, 10);
    el("g3meta").textContent = `Top ${clientTop.length}`;
    chart3 = new Chart(el("chart3"), {
      type:"bar",
      data:{ labels: clientTop.map(([k])=>k), datasets:[{ label:"Chamados", data: clientTop.map(([,v])=>v) }] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
    });
  } else {
    el("g3title").textContent = "Chamados por técnico";
    const byTech = groupCount(filtered, r=>r.tecnico || "(vazio)");
    const techTop = topN(byTech, 10);
    el("g3meta").textContent = `Top ${techTop.length}`;
    chart3 = new Chart(el("chart3"), {
      type:"bar",
      data:{ labels: techTop.map(([k])=>k), datasets:[{ label:"Chamados", data: techTop.map(([,v])=>v) }] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
    });
  }

  // Chart 4: Top equipamentos (qty)
  const eqMap = new Map();
  for (const r of filtered){
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) eqMap.set(col, (eqMap.get(col)||0)+v);
    }
  }
  const eqTop = topN(eqMap, 10);
  el("g4meta").textContent = `Top ${eqTop.length}`;

  destroyIfExists(chart4);
  chart4 = new Chart(el("chart4"), {
    type:"bar",
    data:{ labels: eqTop.map(([k])=>k), datasets:[{ label:"Quantidade", data: eqTop.map(([,v])=>v) }] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
  });

  // clique para drill
  el("chart3").onclick = (evt)=>{
    const points = chart3.getElementsAtEventForMode(evt, "nearest", {intersect:true}, true);
    if (!points.length) return;
    const label = chart3.data.labels[points[0].index];
    if (moduleSel.value==="operacoes") openDrill("cliente", label);
    else openDrill("tecnico", label);
  };
}

/* =========================
   TABELA + DRILL
========================= */
function renderTable(){
  pageSize = Number(el("pageSize").value || 50);
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  page = Math.min(page, totalPages);

  const start = (page - 1) * pageSize;
  const end = Math.min(total, start + pageSize);
  const slice = filtered.slice(start, end);

  tbody.innerHTML = "";
  for (const r of slice){
    const tr = document.createElement("tr");
    tr.className = "border-t hover:bg-slate-50";

    tr.innerHTML = `
      <td class="p-2">${escapeHtml(r.base)}</td>
      <td class="p-2 mono">${r.data || ""}</td>
      <td class="p-2 mono">${escapeHtml(r.chamado)}</td>
      <td class="p-2">
        <button class="underline decoration-dotted hover:decoration-solid" data-drill="cliente">${escapeHtml(r.cliente)}</button>
      </td>
      <td class="p-2">
        <button class="underline decoration-dotted hover:decoration-solid" data-drill="tecnico">${escapeHtml(r.tecnico)}</button>
      </td>
      <td class="p-2">${escapeHtml(r.tipo)}</td>
      <td class="p-2 mono">${r.acrescimo || 0}</td>
      <td class="p-2">${escapeHtml(r.motivo)}</td>
    `;

    tr.querySelectorAll("button[data-drill]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const kind = btn.getAttribute("data-drill");
        const label = btn.textContent.trim() || "(vazio)";
        if (moduleSel.value==="rh" && kind==="cliente") return;
        openDrill(kind, label);
      });
    });

    tbody.appendChild(tr);
  }

  pagerInfo.textContent = `Página ${page}/${totalPages} • linhas ${start+1}-${end} de ${total}`;
  btnPrev.disabled = (page<=1);
  btnNext.disabled = (page>=totalPages);
  btnPrev.classList.toggle("opacity-50", btnPrev.disabled);
  btnNext.classList.toggle("opacity-50", btnNext.disabled);
}

function openDrill(kind, label){
  drillModal.classList.remove("hidden");
  drillModal.classList.add("flex");

  let recs;
  if (kind==="tecnico") recs = filtered.filter(r=>(r.tecnico||"(vazio)")===label);
  else recs = filtered.filter(r=>(r.cliente||"(vazio)")===label);

  const acresc = recs.reduce((a,r)=>a+(r.acrescimo||0),0);
  const equipS = sumEquip(recs);
  const reinc = calcReinc(recs);
  const prod = avgChamadosPorDia(recs);

  dTitle.textContent = `Drill-down: ${kind.toUpperCase()} • ${label}`;
  dSub.textContent = `${recs.length} registro(s) no recorte atual`;

  const kpis = [];
  kpis.push(["Chamados", recs.length]);
  kpis.push(["Prod/dia", prod===null ? "—" : prod.toFixed(2)]);
  kpis.push(["Acréscimos", acresc]);
  kpis.push(["Equip (qty)", equipS]);
  kpis.push(["Reincidência", `${reinc.pct}%`]);

  dKpis.innerHTML = "";
  for (const [k,v] of kpis){
    const div = document.createElement("div");
    div.innerHTML = `<span class="muted">${escapeHtml(k)}:</span> ${mono(v)}`;
    dKpis.appendChild(div);
  }

  const byDay = groupCount(recs, r=>r.data || "(sem data)");
  const entries = [...byDay.entries()].sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
  const labels = entries.map(([k])=>k);
  const data   = entries.map(([,v])=>v);
  dMeta.textContent = `${labels.length} dia(s)`;

  destroyIfExists(dChart);
  dChart = new Chart(el("dChart"), {
    type:"line",
    data:{ labels, datasets:[{ label:"Chamados", data, tension:0.25 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ x:{ticks:{maxRotation:0,autoSkip:true}}, y:{beginAtZero:true,ticks:{precision:0}} }
    }
  });

  const topClients = topN(groupCount(recs, r=>r.cliente||"(vazio)"), 8);
  const topReasons = topN(groupCount(recs, r=>r.motivo||"(vazio)"), 8);

  dTopClients.innerHTML = topClients.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of topClients){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">(${v})</span>`;
    dTopClients.appendChild(div);
  }

  dTopReasons.innerHTML = topReasons.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of topReasons){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">(${v})</span>`;
    dTopReasons.appendChild(div);
  }

  const eqMap = new Map();
  for (const r of recs){
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) eqMap.set(col, (eqMap.get(col)||0)+v);
    }
  }
  const eqTop = topN(eqMap, 10);
  dTopEquip.innerHTML = eqTop.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of eqTop){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">× ${v}</span>`;
    dTopEquip.appendChild(div);
  }
}
function closeDrill(){
  drillModal.classList.add("hidden");
  drillModal.classList.remove("flex");
}

/* =========================
   AUTOCOMPLETE CLIENTE
========================= */
let clientNames = [];
function updateSuggest(query){
  const q = safeStr(query).toLowerCase();
  if (!q || !clientNames.length){
    clientSuggest.classList.add("hidden"); clientSuggest.innerHTML = ""; return;
  }
  const hits = clientNames.filter(n=>n.toLowerCase().includes(q)).slice(0, 12);
  if (!hits.length){
    clientSuggest.classList.add("hidden"); clientSuggest.innerHTML = ""; return;
  }
  clientSuggest.classList.remove("hidden");
  clientSuggest.innerHTML = hits.map(n=>`
    <button class="w-full text-left px-3 py-2 hover:bg-slate-50 border-b last:border-b-0" data-client="${escapeHtml(n)}">
      ${escapeHtml(n)}
    </button>
  `).join("");

  clientSuggest.querySelectorAll("button[data-client]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const name = btn.getAttribute("data-client");
      fCliente.value = name;
      clientSearch.value = name;
      clientSuggest.classList.add("hidden");
      applyFilters();
      setTimeout(()=>el("page-dashboard").scrollIntoView({behavior:"smooth", block:"start"}), 120);
    });
  });
}

/* =========================
   EXPORT
========================= */
function exportCSV(){
  const headers = ["base","data","month","chamado","cliente","tecnico","tipo","acrescimo","motivo","sheet", ...equipColumns];
  const lines = [headers.join(";")];

  for (const r of filtered){
    const row = [
      r.base, r.data, r.month, r.chamado, r.cliente, r.tecnico, r.tipo,
      String(r.acrescimo||0),
      r.motivo, r.sheet,
      ...equipColumns.map(c => String(toInt((r._raw||{})[c]) || 0))
    ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`);
    lines.push(row.join(";"));
  }
  downloadFile(`smartconecta_filtrado.csv`, lines.join("\n"), "text/csv;charset=utf-8");
}

function exportJSON(){
  const out = filtered.map(r=>{
    const eq = {};
    for (const c of equipColumns){
      const v = toInt((r._raw||{})[c]);
      if (v) eq[c]=v;
    }
    return {
      base:r.base,
      data:r.data, month:r.month,
      chamado:r.chamado, cliente:r.cliente, tecnico:r.tecnico,
      tipo:r.tipo, acrescimo:r.acrescimo||0,
      motivo:r.motivo, sheet:r.sheet,
      equipamentos:eq
    };
  });
  downloadFile(`smartconecta_filtrado.json`, JSON.stringify(out,null,2), "application/json;charset=utf-8");
}

function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   META + DROPDOWNS
========================= */
function fillSelect(selectEl, values){
  const cur = selectEl.value;
  selectEl.innerHTML = `<option value="">(Todos)</option>`;
  for (const v of values){
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    selectEl.appendChild(opt);
  }
  if (values.includes(cur)) selectEl.value = cur;
}

function refreshFilterOptions(){
  const clientes = uniqSorted(rawRecords.map(r=>r.cliente).filter(v=>v && v!=="(vazio)"));
  const tecnicos = uniqSorted(rawRecords.map(r=>r.tecnico).filter(v=>v && v!=="(vazio)"));
  const tipos    = uniqSorted(rawRecords.map(r=>r.tipo).filter(v=>v && v!=="(vazio)"));

  fillSelect(fCliente, clientes);
  fillSelect(fTecnico, tecnicos);

  const tiposOk = uniqSorted(tipos.filter(t=>VALID_TIPOS.includes(t)));
  fTipo.innerHTML = `<option value="">(Todos)</option>` + tiposOk.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

  fEquip.innerHTML = `<option value="">(Todos)</option>`;
  for (const col of equipColumns){
    const opt = document.createElement("option");
    opt.value = col; opt.textContent = col;
    fEquip.appendChild(opt);
  }

  clientNames = clientes;
  fillMonthsCheckboxes();
}

function renderMeta(){
  metaTotal.textContent = rawRecords.length ? String(rawRecords.length) : "—";
  const dates = rawRecords.map(r=>r.data).filter(Boolean).sort();
  metaPeriod.textContent = dates.length ? `${dates[0]} → ${dates[dates.length-1]}` : "—";
  metaEquip.textContent = String(equipColumns.length);
  metaFiltered.textContent = filtered.length ? String(filtered.length) : "—";
}

/* =========================
   NAVEGAÇÃO
========================= */
function showPage(pageKey){
  for (const [k, node] of Object.entries(pages)){
    node.classList.toggle("hidden", k !== pageKey);
  }
  navBtns.forEach(b=>{
    b.classList.toggle("activeNav", b.getAttribute("data-page")===pageKey);
  });

  if (pageKey==="comparativo") renderMonthlyComparison();
  if (pageKey==="alertas") renderAlerts();
  if (pageKey==="acrescimos") analyzeAcrescimos();
}
navBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>showPage(btn.getAttribute("data-page")));
});

/* =========================
   RENDER GERAL
========================= */
function renderAll(){
  renderMeta();
  renderKPIs();
  buildCharts();
  renderDominantEquip();
  renderEquipHealth();
  renderTable();

  const ok = filtered.length > 0;
  btnExportCSV.disabled = !ok;
  btnExportJSON.disabled = !ok;
}

/* =========================
   RESET
========================= */
function resetFilters(reRender=true){
  fBase.value="";
  fCliente.value=""; fTecnico.value=""; fTipo.value=""; fEquip.value="";
  fDe.value=""; fAte.value=""; fSearch.value="";
  clientSearch.value="";
  clientSuggest.classList.add("hidden"); clientSuggest.innerHTML="";
  selectedMonths.clear();
  page=1;
  if (reRender) applyFilters();
}

/* =========================
   EVENTOS
========================= */
fileInput.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;

  dotStatus.className = "w-2.5 h-2.5 rounded-full bg-amber-500";
  statusLine.textContent = "Carregando…";

  try{
    rawRecords = await loadXLSX(file);
    if (!rawRecords.length) throw new Error("Planilha vazia ou sem dados válidos");
    
    equipColumns = detectEquipColumns(rawRecords);
    healthSelectedCol = null;
    selectedMonths.clear();

    refreshFilterOptions();
    applyModuleUI();
    resetFilters(false);

    dotStatus.className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
    statusLine.textContent = `${file.name} • ${rawRecords.length} registros`;

    applyFilters();
  }catch(err){
    console.error("Erro ao carregar arquivo:", err);
    dotStatus.className = "w-2.5 h-2.5 rounded-full bg-rose-500";
    statusLine.textContent = `Erro: ${err.message || "Formato inválido"}`;
    rawRecords = [];
    filtered = [];
    renderAll();
  }finally{
    fileInput.value="";
  }
});

moduleSel.addEventListener("change", ()=>{
  applyModuleUI();
  applyFilters();
});

btnReset.addEventListener("click", ()=>resetFilters(true));
btnExportCSV.addEventListener("click", exportCSV);
btnExportJSON.addEventListener("click", exportJSON);

[fBase, fCliente, fTecnico, fTipo, fEquip, fDe, fAte].forEach(x=>x.addEventListener("change", applyFilters));
fSearch.addEventListener("input", debounce(applyFilters, 300));

// Eventos de alertas
alertDias.addEventListener("change", renderAlerts);
alertMinManut.addEventListener("change", renderAlerts);
btnRefreshAlerts.addEventListener("click", renderAlerts);
btnPrintAlerts.addEventListener("click", printAlerts);

// Eventos de acréscimos
acrescWindowDays.addEventListener("change", analyzeAcrescimos);
acrescTipo.addEventListener("change", analyzeAcrescimos);
acrescCliente.addEventListener("input", debounce(analyzeAcrescimos, 300));
btnRefreshAcresc.addEventListener("click", analyzeAcrescimos);

healthWindowDays.addEventListener("change", renderEquipHealth);

el("pageSize").addEventListener("change", ()=>{ page=1; renderTable(); });
btnPrev.addEventListener("click", ()=>{ page=Math.max(1,page-1); renderTable(); });
btnNext.addEventListener("click", ()=>{ page=page+1; renderTable(); });

dClose.addEventListener("click", closeDrill);
drillModal.addEventListener("click", (e)=>{ if (e.target===drillModal) closeDrill(); });

clientSearch.addEventListener("input", ()=>updateSuggest(clientSearch.value));
clientSearch.addEventListener("keydown", (e)=>{
  if (e.key==="Enter"){
    e.preventDefault();
    const name = safeStr(clientSearch.value);
    if (clientNames.includes(name)){
      fCliente.value = name;
      clientSuggest.classList.add("hidden");
      applyFilters();
    }
  }
  if (e.key==="Escape") clientSuggest.classList.add("hidden");
});

document.addEventListener("keydown", (e)=>{
  if (e.key==="/"){
    e.preventDefault();
    if (moduleSel.value!=="rh") clientSearch.focus();
    else fSearch.focus();
  }
  if (e.key==="Escape"){
    closeDrill();
    clientSuggest.classList.add("hidden");
  }
});

function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* =========================
   INIT charts vazios
========================= */
(function initEmpty(){
  const empty = { type:"bar", data:{labels:[],datasets:[{data:[]}]}, options:{plugins:{legend:{display:false}}} };
  chart1 = new Chart(el("chart1"), {...empty, type:"line"});
  chart2 = new Chart(el("chart2"), {...empty, type:"pie"});
  chart3 = new Chart(el("chart3"), empty);
  chart4 = new Chart(el("chart4"), empty);

  compareChart1 = new Chart(el("compareChart1"), empty);
  compareChart2 = new Chart(el("compareChart2"), empty);

  // navegação inicial
  showPage("dashboard");
  applyModuleUI();
})();
</script>
</body>
</html>
