<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Conecta • Portal Operacional & RH (V5)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .glass { background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
    .card { border: 1px solid rgba(148,163,184,.35); }
    .muted { color: rgb(100 116 139); }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .chip { border: 1px solid rgba(148,163,184,.45); }
    .shadowSoft { box-shadow: 0 10px 30px rgba(2,6,23,.08); }
    .btn { border: 1px solid rgba(148,163,184,.55); }
    .btnPrimary { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
    .btnPrimary:hover { filter: brightness(1.08); }
    .btn:hover { background: rgb(248 250 252); }
    .kpiVal { letter-spacing: -0.02em; }
    .activeNav { background: rgba(15,23,42,.08); border-color: rgba(15,23,42,.18); }
    
    /* Estilos para alertas */
    .alert-high { border-left: 4px solid #ef4444; background-color: #fef2f2; }
    .alert-medium { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
    .alert-low { border-left: 4px solid #3b82f6; background-color: #eff6ff; }
    .alert-expanded { background-color: #f8fafc; }
    .alert-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .alert-details.open { max-height: 500px; }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-900">
  <!-- BACKGROUND -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-24 -left-24 w-[520px] h-[520px] rounded-full blur-3xl opacity-35 bg-gradient-to-br from-emerald-400 to-cyan-400"></div>
    <div class="absolute -bottom-24 -right-24 w-[520px] h-[520px] rounded-full blur-3xl opacity-30 bg-gradient-to-br from-fuchsia-400 to-indigo-400"></div>
  </div>

  <div class="max-w-[1400px] mx-auto px-4 py-4">
    <!-- TOP BAR -->
    <header class="glass shadowSoft card rounded-2xl px-4 py-4 flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-semibold">SC</div>
        <div>
          <div class="text-xl font-semibold text-slate-900">Portal • Operacional & RH</div>
          <div class="text-xs muted">KPIs • Mix • Equip líderes por tipo • Comparação mês • Saúde por equipamento (todos) • Alertas</div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label class="btn btnPrimary px-3 py-2 rounded-xl cursor-pointer text-sm shadowSoft">
          Carregar XLSX
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden"/>
        </label>

        <div class="flex items-center gap-2">
          <div class="text-xs muted">Módulo</div>
          <select id="moduleSel" class="btn px-3 py-2 rounded-xl bg-white text-sm">
            <option value="operacoes" selected>Operacional</option>
            <option value="rh">RH</option>
          </select>
        </div>

        <button id="btnReset" class="btn px-3 py-2 rounded-xl bg-white text-sm">Reset</button>

        <button id="btnExportCSV" class="btn px-3 py-2 rounded-xl bg-white text-sm disabled:opacity-50" disabled>CSV</button>
        <button id="btnExportJSON" class="btn px-3 py-2 rounded-xl bg-white text-sm disabled:opacity-50" disabled>JSON</button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-4">
      <!-- SIDEBAR -->
      <aside class="lg:col-span-3">
        <div class="glass shadowSoft card rounded-2xl p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Navegação</div>
            <div class="w-2.5 h-2.5 rounded-full bg-slate-300" id="dotStatus"></div>
          </div>

          <div class="text-xs muted mt-1" id="statusLine">Carregue um XLSX para iniciar.</div>

          <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
            <div class="chip rounded-xl p-2 bg-white">
              <div class="muted">Registros</div>
              <div class="mono font-semibold" id="metaTotal">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white">
              <div class="muted">Período</div>
              <div class="mono font-semibold" id="metaPeriod">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white">
              <div class="muted">Equip col.</div>
              <div class="mono font-semibold" id="metaEquip">—</div>
            </div>
            <div class="chip rounded-xl p-2 bg-white">
              <div class="muted">Após filtros</div>
              <div class="mono font-semibold" id="metaFiltered">—</div>
            </div>
          </div>

          <div class="mt-4 space-y-2">
            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white activeNav" data-page="dashboard">
              <div class="text-sm font-semibold">Dashboard</div>
              <div class="text-xs muted">KPIs + gráficos + insights</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white" data-page="comparativo">
              <div class="text-sm font-semibold">Comparação mês</div>
              <div class="text-xs muted">Análise mensal por tipo de serviço</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white" data-page="registros">
              <div class="text-sm font-semibold">Registros</div>
              <div class="text-xs muted">Tabela filtrada + drill</div>
            </button>

            <button class="navBtn btn w-full text-left px-3 py-2 rounded-xl bg-white" data-page="alertas">
              <div class="text-sm font-semibold">Alertas</div>
              <div class="text-xs muted">Clientes problemáticos + situações críticas</div>
            </button>
          </div>

          <div class="mt-4 text-xs muted">
            Dica: clique em <b>Cliente</b> ou <b>Técnico</b> na tabela para drill-down.
          </div>
        </div>

        <!-- FILTERS -->
        <div class="glass shadowSoft card rounded-2xl p-3 mt-4">
          <div class="text-sm font-semibold">Filtros</div>
          <div class="text-xs muted">Aplique e o portal recalcula tudo.</div>

          <div class="mt-3">
            <label class="text-xs muted">Base</label>
            <select id="fBase" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
              <option value="">(Conecta + Visium)</option>
              <option value="Conecta">Conecta</option>
              <option value="Visium">Visium</option>
            </select>
          </div>

          <div id="wrapCliente" class="mt-3">
            <label class="text-xs muted">Cliente (busca)</label>
            <input id="clientSearch" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white" placeholder="Digite e selecione…"/>
            <div id="clientSuggest" class="hidden mt-1 border rounded-xl bg-white max-h-56 overflow-auto"></div>

            <label class="text-xs muted mt-2 block">Cliente (filtro)</label>
            <select id="fCliente" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Técnico</label>
            <select id="fTecnico" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Tipo de chamado</label>
            <select id="fTipo" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
              <option value="">(Todos)</option>
            </select>
            <div class="text-[11px] muted mt-1">Padronizado para: Montagem, Manutenção, Retirada, Troca, Revisão.</div>
          </div>

          <div class="mt-3" id="wrapEquip">
            <label class="text-xs muted">Equipamento (coluna)</label>
            <select id="fEquip" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
              <option value="">(Todos)</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <div>
              <label class="text-xs muted">De</label>
              <input id="fDe" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white"/>
            </div>
            <div>
              <label class="text-xs muted">Até</label>
              <input id="fAte" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white"/>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-xs muted">Busca geral</label>
            <input id="fSearch" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white" placeholder="Ex.: retirada, All Easy, 28946…"/>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <div>
              <label class="text-xs muted">Alerta: dias entre manutenções</label>
              <input id="alertDias" type="number" min="1" value="30" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white"/>
            </div>
            <div>
              <label class="text-xs muted">Min. manutenções</label>
              <input id="alertMinManut" type="number" min="2" value="3" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white"/>
            </div>
          </div>

          <!-- NEW: Health window for ALL equipment -->
          <div id="wrapHealthWin" class="mt-3">
            <label class="text-xs muted">Saúde: janela pós-montagem (dias)</label>
            <input id="healthWindowDays" type="number" min="1" value="14" class="mt-1 w-full px-3 py-2 rounded-xl border bg-white"/>
            <div class="text-[11px] muted mt-1">Detecta Manutenção até X dias após Montagem (entrega=montagem), por cliente + coluna de equipamento.</div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <section class="lg:col-span-9 space-y-4">
        <!-- PAGE: DASHBOARD -->
        <div id="page-dashboard" class="glass shadowSoft card rounded-2xl p-4">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-semibold">Dashboard</div>
              <div class="text-xs muted">KPIs do recorte + mix + equipamentos + saúde por equipamento</div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs">
                <span class="muted">Mês detectado:</span> <span class="mono font-semibold" id="currentMonthLabel">—</span>
              </div>
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs">
                <span class="muted">Tendência:</span> <span class="mono font-semibold" id="trendLabel">—</span>
              </div>
            </div>
          </div>

          <div id="kpiGrid" class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4"></div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-4">
            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Chamados por dia</div>
                <div class="text-xs muted" id="g1meta">—</div>
              </div>
              <canvas id="chart1" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Mix de tipo</div>
                <div class="text-xs muted" id="g2meta">—</div>
              </div>
              <canvas id="chart2" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold" id="g3title">Top clientes (volume)</div>
                <div class="text-xs muted" id="g3meta">—</div>
              </div>
              <canvas id="chart3" height="120"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Top equipamentos (qty)</div>
                <div class="text-xs muted" id="g4meta">—</div>
              </div>
              <canvas id="chart4" height="120"></canvas>
            </div>
          </div>

          <!-- OP: equipamento líder por tipo dominante -->
          <div id="opDominantEquip" class="hidden mt-4 card rounded-2xl p-4 bg-white"></div>

          <!-- OP: Health (ALL equipment) -->
          <div id="equipHealthWrap" class="hidden mt-4 card rounded-2xl p-4 bg-white"></div>
        </div>

        <!-- PAGE: COMPARATIVO -->
        <div id="page-comparativo" class="hidden glass shadowSoft card rounded-2xl p-4">
          <div class="flex items-start justify-between flex-wrap gap-3">
            <div>
              <div class="text-lg font-semibold">Comparação mensal</div>
              <div class="text-xs muted">Selecione os meses para comparar. Gráficos mostram apenas Montagem, Manutenção, Retirada, Troca e Revisão.</div>
            </div>
          </div>

          <!-- Seletor de meses -->
          <div class="mt-4 card rounded-2xl p-3 bg-white">
            <div class="text-sm font-semibold">Selecione os meses para comparar</div>
            <div class="text-xs muted mt-1">Clique nos meses que deseja incluir na análise</div>
            <div id="monthsCheckboxContainer" class="mt-3 flex flex-wrap gap-2"></div>
          </div>

          <!-- KPIs por mês -->
          <div id="monthlyKPIs" class="mt-4"></div>

          <!-- Gráficos -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-4">
            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Comparação por tipo de serviço</div>
                <div class="text-xs muted" id="compareMeta1">—</div>
              </div>
              <canvas id="compareChart1" height="160"></canvas>
            </div>

            <div class="card rounded-2xl p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Evolução mensal total</div>
                <div class="text-xs muted" id="compareMeta2">—</div>
              </div>
              <canvas id="compareChart2" height="160"></canvas>
            </div>
          </div>

          <!-- Tabela comparativa -->
          <div class="mt-4 card rounded-2xl p-3 bg-white">
            <div class="text-sm font-semibold">Tabela comparativa detalhada</div>
            <div class="text-xs muted">Valores por tipo de serviço em cada mês selecionado</div>
            <div class="mt-3 overflow-auto border rounded-2xl">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-100">
                  <tr class="text-left">
                    <th class="p-2">Tipo</th>
                    <!-- Cabeçalhos serão preenchidos dinamicamente -->
                  </tr>
                </thead>
                <tbody id="compareTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PAGE: REGISTROS -->
        <div id="page-registros" class="hidden glass shadowSoft card rounded-2xl p-4">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <div class="text-lg font-semibold">Registros</div>
              <div class="text-xs muted">Tabela filtrada. Clique em Cliente/Técnico para drill-down.</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs muted">Linhas:</span>
              <select id="pageSize" class="btn px-2 py-1 rounded-xl bg-white text-sm">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="250">250</option>
              </select>
            </div>
          </div>

          <div class="overflow-auto mt-3 border rounded-2xl bg-white">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 sticky top-0">
                <tr class="text-left">
                  <th class="p-2">Base</th>
                  <th class="p-2">Data</th>
                  <th class="p-2">Chamado</th>
                  <th class="p-2">Cliente</th>
                  <th class="p-2">Técnico</th>
                  <th class="p-2">Tipo</th>
                  <th class="p-2">Acrésc.</th>
                  <th class="p-2">Motivo</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="flex items-center justify-between mt-3">
            <div class="text-xs muted" id="pagerInfo">—</div>
            <div class="flex items-center gap-2">
              <button id="btnPrev" class="btn px-3 py-1.5 rounded-xl bg-white text-sm">Anterior</button>
              <button id="btnNext" class="btn px-3 py-1.5 rounded-xl bg-white text-sm">Próximo</button>
            </div>
          </div>
        </div>

        <!-- PAGE: ALERTAS (NOVA) -->
        <div id="page-alertas" class="hidden glass shadowSoft card rounded-2xl p-4">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
            <div>
              <div class="text-lg font-semibold">Alertas - Situações Críticas</div>
              <div class="text-xs muted">Clientes com múltiplas manutenções em pouco tempo. Clique para expandir detalhes.</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="chip rounded-xl px-3 py-2 bg-white text-xs">
                <span class="muted">Período de alerta:</span> 
                <span class="mono font-semibold" id="alertPeriodLabel">30 dias</span>
              </div>
              <button id="btnRefreshAlerts" class="btn px-3 py-1.5 rounded-xl bg-white text-sm">Atualizar alertas</button>
            </div>
          </div>

          <!-- Resumo dos alertas -->
          <div id="alertSummary" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Será preenchido dinamicamente -->
          </div>

          <!-- Lista de alertas -->
          <div id="alertsContainer">
            <div class="text-sm muted text-center p-4" id="noAlertsMessage">
              Nenhum alerta encontrado. Ajuste os parâmetros ou carregue mais dados.
            </div>
            <!-- Alertas serão inseridos aqui -->
          </div>

          <!-- Legenda -->
          <div class="mt-4 p-3 bg-white border rounded-xl">
            <div class="text-sm font-semibold mb-2">Legenda dos alertas:</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span><b>Alta criticidade:</b> 5+ manutenções em 30 dias</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <span><b>Média criticidade:</b> 3-4 manutenções em 30 dias</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <span><b>Baixa criticidade:</b> Múltiplas manutenções (check padrão)</span>
              </div>
            </div>
            <div class="mt-2 text-xs muted">
              <b>Nota:</b> Alertas consideram apenas chamados do tipo "Manutenção" dentro do período configurado.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- DRILL MODAL -->
  <div id="drillModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="glass shadowSoft card rounded-2xl w-full max-w-6xl p-0 overflow-hidden">
      <div class="px-4 py-3 border-b bg-white flex items-start justify-between gap-3">
        <div>
          <div class="text-lg font-semibold" id="dTitle">Drill-down</div>
          <div class="text-xs muted" id="dSub">—</div>
        </div>
        <button id="dClose" class="btn px-3 py-1.5 rounded-xl bg-white text-sm">Fechar</button>
      </div>

      <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="card rounded-2xl p-3 bg-white">
          <div class="text-xs muted">KPIs</div>
          <div id="dKpis" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white lg:col-span-2">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Linha do tempo</div>
            <div class="text-xs muted" id="dMeta">—</div>
          </div>
          <canvas id="dChart" height="110"></canvas>
        </div>

        <div class="card rounded-2xl p-3 bg-white">
          <div class="text-sm font-semibold">Top clientes</div>
          <div id="dTopClients" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white">
          <div class="text-sm font-semibold">Top motivos</div>
          <div id="dTopReasons" class="mt-2 space-y-1 text-sm"></div>
        </div>

        <div class="card rounded-2xl p-3 bg-white">
          <div class="text-sm font-semibold">Top equipamentos</div>
          <div id="dTopEquip" class="mt-2 space-y-1 text-sm"></div>
        </div>
      </div>

      <div class="px-4 py-3 border-t bg-white text-xs muted">
        Reincidência: mesmo cliente + motivo similar dentro da janela configurada.
      </div>
    </div>
  </div>

<script>
/* =========================
   BASE
========================= */
const FIXED_FIELDS = new Set([
  "Data","Empresa","Chamados","Chamado","Cliente","Cliente/Empresa","Motivo","tecnico","Técnico","Tecnico",
  "Ajudante","carro","Acrescimo","Acréscimo","Hora Inicio","Hora Final","Tipo de chamado","Tipo",
  "Total Horas","Horas","Total KM","KM Inicio","KM Final","KM inico","Base","Unidade"
]);

const VALID_TIPOS = ["Montagem","Manutenção","Retirada","Troca","Revisão"];

const el = (id)=>document.getElementById(id);
const safeStr = (v)=>String(v ?? "").replace(/\s+/g," ").trim();
const normKey = (k)=>String(k ?? "").trim();

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
const mono = (v)=>`<span class="mono font-semibold">${escapeHtml(v)}</span>`;

function toInt(v){
  const n = Number(String(v ?? "").replace(",","."));
  return Number.isFinite(n) ? n : 0;
}

function toISODate(v){
  if (v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
  if (typeof v === "number") {
    const d = XLSX.SSF.parse_date_code(v);
    if (d) {
      const dt = new Date(Date.UTC(d.y, d.m - 1, d.d));
      return dt.toISOString().slice(0,10);
    }
  }
  const s = String(v ?? "").trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) return s;
  return "";
}

function daysBetween(isoA, isoB){
  if (!isoA || !isoB) return null;
  const a = new Date(isoA+"T00:00:00Z").getTime();
  const b = new Date(isoB+"T00:00:00Z").getTime();
  return Math.round((b-a)/(1000*60*60*24));
}
function monthKey(iso){ return (!iso || iso.length<7) ? "" : iso.slice(0,7); }
function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b), "pt-BR")); }
function groupCount(arr, keyFn){
  const m = new Map();
  for (const it of arr){
    const k = keyFn(it) || "(vazio)";
    m.set(k, (m.get(k) || 0) + 1);
  }
  return m;
}
function topN(map, n=10){ return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n); }
function destroyIfExists(ch){ if (ch && typeof ch.destroy==="function") ch.destroy(); }

function motivoTokens(m){ return safeStr(m).toLowerCase().split(/[^a-zà-ú0-9]+/i).filter(x=>x.length>=3); }
function motivoSimilar(a, b, minCommon=2){
  if (!a || !b) return false;
  const A = new Set(motivoTokens(a));
  const B = new Set(motivoTokens(b));
  let common = 0;
  for (const x of A) if (B.has(x)) { common++; if (common>=minCommon) return true; }
  return false;
}

/* =========================
   ESTADO
========================= */
let rawRecords = [];
let equipColumns = [];
let filtered = [];
let page = 1;
let pageSize = 50;
let healthSelectedCol = null;
let selectedMonths = new Set();
let alertsData = [];

let chart1, chart2, chart3, chart4;
let compareChart1, compareChart2;
let dChart;

/* =========================
   ELEMENTOS
========================= */
const fileInput = el("fileInput");
const dotStatus = el("dotStatus");
const statusLine= el("statusLine");
const moduleSel = el("moduleSel");
const btnReset  = el("btnReset");
const btnExportCSV = el("btnExportCSV");
const btnExportJSON= el("btnExportJSON");

const metaTotal = el("metaTotal");
const metaPeriod= el("metaPeriod");
const metaEquip = el("metaEquip");
const metaFiltered = el("metaFiltered");

const fBase   = el("fBase");
const fCliente = el("fCliente");
const fTecnico = el("fTecnico");
const fTipo    = el("fTipo");
const fEquip   = el("fEquip");
const fDe      = el("fDe");
const fAte     = el("fAte");
const fSearch  = el("fSearch");
const alertDias = el("alertDias");
const alertMinManut = el("alertMinManut");
const healthWindowDays = el("healthWindowDays");

const wrapCliente = el("wrapCliente");
const wrapEquip   = el("wrapEquip");

const clientSearch = el("clientSearch");
const clientSuggest= el("clientSuggest");

const kpiGrid = el("kpiGrid");
const currentMonthLabel = el("currentMonthLabel");
const trendLabel = el("trendLabel");

const opDominantEquip = el("opDominantEquip");
const equipHealthWrap = el("equipHealthWrap");

const pageSizeSel= el("pageSize");
const tbody = el("tbody");
const pagerInfo = el("pagerInfo");
const btnPrev = el("btnPrev");
const btnNext = el("btnNext");

const navBtns = document.querySelectorAll(".navBtn");
const pages = {
  dashboard: el("page-dashboard"),
  comparativo: el("page-comparativo"),
  registros: el("page-registros"),
  alertas: el("page-alertas")
};

// Elementos da página de comparação
const monthsCheckboxContainer = el("monthsCheckboxContainer");
const monthlyKPIs = el("monthlyKPIs");
const compareTableBody = el("compareTableBody");

// Elementos da página de alertas
const alertPeriodLabel = el("alertPeriodLabel");
const btnRefreshAlerts = el("btnRefreshAlerts");
const alertSummary = el("alertSummary");
const alertsContainer = el("alertsContainer");
const noAlertsMessage = el("noAlertsMessage");

// Drill
const drillModal = el("drillModal");
const dClose = el("dClose");
const dTitle = el("dTitle");
const dSub   = el("dSub");
const dMeta  = el("dMeta");
const dKpis  = el("dKpis");
const dTopClients = el("dTopClients");
const dTopReasons = el("dTopReasons");
const dTopEquip   = el("dTopEquip");

/* =========================
   NORMALIZAÇÃO
========================= */
function inferBase(obj, sheetName){
  const b = safeStr(obj["Base"] || obj["Empresa"] || "");
  const s = (sheetName||"").toLowerCase();
  const bb = b.toLowerCase();
  if (bb.includes("visium") || s.includes("visium")) return "Visium";
  if (bb.includes("conecta") || s.includes("conecta") || s.includes("smart")) return "Conecta";
  return "Conecta";
}

function normalizeTipo(rawTipo){
  const t = safeStr(rawTipo).toLowerCase();
  if (!t) return "";
  if (t.includes("mont")) return "Montagem";
  if (t.includes("retir")) return "Retirada";
  if (t.includes("manut")) return "Manutenção";
  if (t.includes("troc")) return "Troca";
  if (t.includes("revis")) return "Revisão";
  const cap = t.charAt(0).toUpperCase()+t.slice(1);
  return VALID_TIPOS.includes(cap) ? cap : cap;
}

function normalizeRow(raw, sheetName){
  const obj = {};
  for (const [k,v] of Object.entries(raw)) obj[normKey(k)] = v;

  const dataISO = toISODate(obj["Data"]);
  const chamado = safeStr(obj["Chamados"] || obj["Chamado"] || "");
  const cliente = safeStr(obj["Cliente"] || obj["Empresa"] || obj["Cliente/Empresa"] || "");
  const tecnico = safeStr(obj["tecnico"] || obj["Técnico"] || obj["Tecnico"] || "");
  const tipo    = normalizeTipo(obj["Tipo de chamado"] || obj["Tipo"] || "");
  const motivo  = safeStr(obj["Motivo"] || "");
  const acresc  = toInt(obj["Acrescimo"] || obj["Acréscimo"] || 0);

  const base = inferBase(obj, sheetName);

  return {
    sheet: sheetName,
    base,
    carro: safeStr(obj["carro"] || obj["Carro"] || ""),
    data: dataISO,
    month: monthKey(dataISO),
    chamado, cliente, tecnico, tipo, motivo,
    acrescimo: acresc,
    _raw: obj
  };
}

async function loadXLSX(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array", cellDates:true});
  const all = [];
  for (const name of wb.SheetNames){
    const ws = wb.Sheets[name];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
    for (const row of rows){
      const hasAny = Object.values(row).some(v => String(v ?? "").trim() !== "");
      if (!hasAny) continue;
      all.push(normalizeRow(row, name));
    }
  }
  return all;
}

function detectEquipColumns(records){
  const sums = new Map();
  for (const r of records){
    for (const [k,v] of Object.entries(r._raw || {})){
      const kk = normKey(k);
      if (!kk) continue;
      if (FIXED_FIELDS.has(kk)) continue;
      if (/^Unnamed/i.test(kk)) continue;
      const num = toInt(v);
      if (num > 0) sums.set(kk, (sums.get(kk)||0) + num);
    }
  }
  return [...sums.entries()].sort((a,b)=>b[1]-a[1]).map(([k])=>k);
}

/* =========================
   SISTEMA DE ALERTAS
========================= */
function detectAlerts() {
  const daysWindow = Math.max(1, toInt(alertDias.value));
  const minManut = Math.max(2, toInt(alertMinManut.value));
  
  alertPeriodLabel.textContent = `${daysWindow} dias`;
  
  // Filtrar apenas manutenções
  const manutencaoRecords = filtered.filter(r => r.tipo === "Manutenção");
  
  if (manutencaoRecords.length === 0) {
    alertsData = [];
    return;
  }
  
  // Agrupar por cliente
  const byClient = new Map();
  for (const r of manutencaoRecords) {
    const key = r.cliente || "(vazio)";
    if (!byClient.has(key)) byClient.set(key, []);
    byClient.get(key).push(r);
  }
  
  // Analisar cada cliente
  const alerts = [];
  
  for (const [cliente, records] of byClient.entries()) {
    if (records.length < minManut) continue;
    
    // Ordenar por data
    const sorted = records.filter(r => r.data).sort((a, b) => a.data.localeCompare(b.data));
    
    if (sorted.length < minManut) continue;
    
    // Verificar se há manutenções próximas no tempo
    let hasCloseManut = false;
    let maxInWindow = 0;
    let windowStart = null;
    let problematicDates = [];
    
    for (let i = 0; i < sorted.length; i++) {
      const current = sorted[i];
      let countInWindow = 1;
      const windowDates = [current.data];
      
      for (let j = i + 1; j < sorted.length; j++) {
        const next = sorted[j];
        const days = daysBetween(current.data, next.data);
        if (days !== null && days <= daysWindow) {
          countInWindow++;
          windowDates.push(next.data);
        } else {
          break;
        }
      }
      
      if (countInWindow >= minManut) {
        hasCloseManut = true;
        if (countInWindow > maxInWindow) {
          maxInWindow = countInWindow;
          problematicDates = windowDates;
          windowStart = current.data;
        }
      }
    }
    
    if (hasCloseManut) {
      // Calcular criticidade
      let severity = "low";
      if (maxInWindow >= 5) severity = "high";
      else if (maxInWindow >= 3) severity = "medium";
      
      // Coletar equipamentos únicos
      const equipamentos = new Set();
      records.forEach(r => {
        for (const col of equipColumns) {
          const qty = toInt((r._raw||{})[col]);
          if (qty > 0) equipamentos.add(col);
        }
      });
      
      // Coletar técnicos únicos
      const tecnicos = new Set(records.map(r => r.tecnico).filter(Boolean));
      
      // Coletar motivos comuns
      const motivos = new Map();
      records.forEach(r => {
        const motivo = r.motivo || "(sem motivo)";
        motivos.set(motivo, (motivos.get(motivo) || 0) + 1);
      });
      const topMotivos = topN(motivos, 3);
      
      alerts.push({
        cliente,
        totalManut: records.length,
        maxInWindow,
        windowDays: daysWindow,
        severity,
        problematicDates,
        windowStart,
        equipamentos: Array.from(equipamentos),
        tecnicos: Array.from(tecnicos),
        topMotivos,
        records: sorted // Manter os registros ordenados
      });
    }
  }
  
  // Ordenar por criticidade (alta primeiro) e depois por quantidade
  alerts.sort((a, b) => {
    const severityOrder = { high: 3, medium: 2, low: 1 };
    if (severityOrder[b.severity] !== severityOrder[a.severity]) {
      return severityOrder[b.severity] - severityOrder[a.severity];
    }
    return b.maxInWindow - a.maxInWindow;
  });
  
  alertsData = alerts;
}

function renderAlerts() {
  detectAlerts();
  
  // Atualizar resumo
  renderAlertSummary();
  
  // Limpar container
  alertsContainer.innerHTML = '';
  
  if (alertsData.length === 0) {
    noAlertsMessage.classList.remove('hidden');
    return;
  }
  
  noAlertsMessage.classList.add('hidden');
  
  // Renderizar cada alerta
  alertsData.forEach((alert, index) => {
    const alertElement = createAlertElement(alert, index);
    alertsContainer.appendChild(alertElement);
  });
}

function renderAlertSummary() {
  const high = alertsData.filter(a => a.severity === 'high').length;
  const medium = alertsData.filter(a => a.severity === 'medium').length;
  const low = alertsData.filter(a => a.severity === 'low').length;
  const total = alertsData.length;
  
  alertSummary.innerHTML = `
    <div class="card rounded-2xl p-4 bg-white">
      <div class="text-xs muted">Total de alertas</div>
      <div class="text-2xl font-semibold mono">${total}</div>
      <div class="text-xs muted">Clientes problemáticos</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-high">
      <div class="text-xs muted">Alta criticidade</div>
      <div class="text-2xl font-semibold mono">${high}</div>
      <div class="text-xs muted">5+ manutenções</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-medium">
      <div class="text-xs muted">Média criticidade</div>
      <div class="text-2xl font-semibold mono">${medium}</div>
      <div class="text-xs muted">3-4 manutenções</div>
    </div>
    
    <div class="card rounded-2xl p-4 bg-white alert-low">
      <div class="text-xs muted">Baixa criticidade</div>
      <div class="text-2xl font-semibold mono">${low}</div>
      <div class="text-xs muted">Múltiplas manutenções</div>
    </div>
  `;
}

function createAlertElement(alert, index) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `mb-3 card rounded-2xl p-4 alert-${alert.severity}`;
  alertDiv.id = `alert-${index}`;
  
  // Cabeçalho do alerta
  const header = document.createElement('div');
  header.className = 'flex items-start justify-between cursor-pointer';
  header.addEventListener('click', () => toggleAlertDetails(index));
  
  const severityBadge = document.createElement('span');
  severityBadge.className = 'px-2 py-1 rounded text-xs font-semibold';
  
  if (alert.severity === 'high') {
    severityBadge.textContent = 'ALTA';
    severityBadge.className += ' bg-red-100 text-red-800';
  } else if (alert.severity === 'medium') {
    severityBadge.textContent = 'MÉDIA';
    severityBadge.className += ' bg-yellow-100 text-yellow-800';
  } else {
    severityBadge.textContent = 'BAIXA';
    severityBadge.className += ' bg-blue-100 text-blue-800';
  }
  
  header.innerHTML = `
    <div class="flex-1">
      <div class="flex items-center gap-2">
        <div class="text-lg font-semibold">${escapeHtml(alert.cliente)}</div>
        ${severityBadge.outerHTML}
      </div>
      <div class="text-xs muted mt-1">
        ${alert.totalManut} manutenções no total • 
        ${alert.maxInWindow} manutenções em ${alert.windowDays} dias •
        Início: ${alert.windowStart || 'N/A'}
      </div>
    </div>
    <div class="text-2xl mono font-semibold ml-2">${alert.maxInWindow}×</div>
  `;
  
  alertDiv.appendChild(header);
  
  // Detalhes do alerta (inicialmente ocultos)
  const details = document.createElement('div');
  details.className = 'alert-details mt-3';
  details.id = `alert-details-${index}`;
  
  // Estatísticas
  const statsDiv = document.createElement('div');
  statsDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 mb-3';
  
  statsDiv.innerHTML = `
    <div class="bg-white p-3 rounded-xl border">
      <div class="text-xs muted">Equipamentos</div>
      <div class="text-sm mt-1">
        ${alert.equipamentos.length > 0 
          ? alert.equipamentos.map(e => `<div class="truncate">${escapeHtml(e)}</div>`).join('')
          : '<div class="text-muted">Nenhum equipamento identificado</div>'}
      </div>
    </div>
    
    <div class="bg-white p-3 rounded-xl border">
      <div class="text-xs muted">Técnicos envolvidos</div>
      <div class="text-sm mt-1">
        ${alert.tecnicos.length > 0 
          ? alert.tecnicos.map(t => `<div>${escapeHtml(t)}</div>`).join('')
          : '<div class="text-muted">Nenhum técnico identificado</div>'}
      </div>
    </div>
    
    <div class="bg-white p-3 rounded-xl border">
      <div class="text-xs muted">Motivos mais comuns</div>
      <div class="text-sm mt-1">
        ${alert.topMotivos.length > 0 
          ? alert.topMotivos.map(([motivo, count]) => `<div class="truncate">${escapeHtml(motivo)} (${count})</div>`).join('')
          : '<div class="text-muted">Nenhum motivo registrado</div>'}
      </div>
    </div>
  `;
  
  details.appendChild(statsDiv);
  
  // Tabela de registros
  const tableTitle = document.createElement('div');
  tableTitle.className = 'text-sm font-semibold mb-2';
  tableTitle.textContent = 'Registros de manutenção (ordenados por data)';
  details.appendChild(tableTitle);
  
  const tableContainer = document.createElement('div');
  tableContainer.className = 'overflow-auto border rounded-xl';
  
  const table = document.createElement('table');
  table.className = 'min-w-full text-sm';
  
  table.innerHTML = `
    <thead class="bg-slate-100">
      <tr class="text-left">
        <th class="p-2">Data</th>
        <th class="p-2">Chamado</th>
        <th class="p-2">Técnico</th>
        <th class="p-2">Acrésc.</th>
        <th class="p-2">Motivo</th>
        <th class="p-2">Equipamentos</th>
      </tr>
    </thead>
    <tbody id="alert-table-${index}">
      <!-- Linhas serão preenchidas abaixo -->
    </tbody>
  `;
  
  const tbody = table.querySelector(`#alert-table-${index}`);
  
  // Limitar a 20 registros para não ficar muito longo
  const displayRecords = alert.records.slice(0, 20);
  
  displayRecords.forEach(record => {
    // Identificar equipamentos nesta manutenção
    const recordEquip = [];
    for (const col of equipColumns) {
      const qty = toInt((record._raw||{})[col]);
      if (qty > 0) recordEquip.push(`${col} (${qty})`);
    }
    
    const tr = document.createElement('tr');
    tr.className = 'border-t hover:bg-slate-50';
    
    tr.innerHTML = `
      <td class="p-2 mono">${record.data || ''}</td>
      <td class="p-2 mono">${escapeHtml(record.chamado)}</td>
      <td class="p-2">${escapeHtml(record.tecnico)}</td>
      <td class="p-2 mono">${record.acrescimo || 0}</td>
      <td class="p-2">${escapeHtml(record.motivo)}</td>
      <td class="p-2 text-xs">${recordEquip.length > 0 ? recordEquip.join(', ') : '—'}</td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Adicionar mensagem se houver mais registros
  if (alert.records.length > 20) {
    const tr = document.createElement('tr');
    tr.className = 'border-t bg-slate-50';
    tr.innerHTML = `
      <td class="p-2 text-center muted" colspan="6">
        ... e mais ${alert.records.length - 20} registro(s)
      </td>
    `;
    tbody.appendChild(tr);
  }
  
  tableContainer.appendChild(table);
  details.appendChild(tableContainer);
  
  // Ações
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'flex justify-between items-center mt-3 pt-3 border-t';
  
  const infoText = document.createElement('div');
  infoText.className = 'text-xs muted';
  infoText.textContent = 'Este cliente tem múltiplas manutenções em um período curto. Considere uma visita técnica mais abrangente.';
  
  const actionButtons = document.createElement('div');
  actionButtons.className = 'flex gap-2';
  
  const filterBtn = document.createElement('button');
  filterBtn.className = 'btn px-3 py-1.5 rounded-xl bg-white text-sm';
  filterBtn.textContent = 'Filtrar este cliente';
  filterBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fCliente.value = alert.cliente;
    applyFilters();
    showPage('dashboard');
  });
  
  const drillBtn = document.createElement('button');
  drillBtn.className = 'btn px-3 py-1.5 rounded-xl bg-white text-sm';
  drillBtn.textContent = 'Ver drill-down';
  drillBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    openDrill('cliente', alert.cliente);
  });
  
  actionButtons.appendChild(filterBtn);
  actionButtons.appendChild(drillBtn);
  
  actionsDiv.appendChild(infoText);
  actionsDiv.appendChild(actionButtons);
  details.appendChild(actionsDiv);
  
  alertDiv.appendChild(details);
  
  return alertDiv;
}

function toggleAlertDetails(index) {
  const details = el(`alert-details-${index}`);
  const alertDiv = el(`alert-${index}`);
  
  if (details.classList.contains('open')) {
    details.classList.remove('open');
    alertDiv.classList.remove('alert-expanded');
  } else {
    // Fechar outros alertas abertos
    document.querySelectorAll('.alert-details.open').forEach(el => {
      el.classList.remove('open');
      el.closest('.card').classList.remove('alert-expanded');
    });
    
    details.classList.add('open');
    alertDiv.classList.add('alert-expanded');
  }
}

/* =========================
   UI por módulo
========================= */
function applyModuleUI(){
  const mod = moduleSel.value;
  if (mod === "rh") wrapCliente.classList.add("hidden");
  else wrapCliente.classList.remove("hidden");

  if (mod === "rh") wrapEquip.classList.add("hidden");
  else wrapEquip.classList.remove("hidden");
}

/* =========================
   FILTROS
========================= */
function applyFilters(){
  const mod = moduleSel.value;
  const base = fBase.value.trim();
  const c = (mod==="rh") ? "" : fCliente.value.trim();
  const t = fTecnico.value.trim();
  const tp= fTipo.value.trim();
  const eq= (mod==="rh") ? "" : fEquip.value.trim();
  const de= fDe.value ? fDe.value : "";
  const ate= fAte.value ? fAte.value : "";
  const s = fSearch.value.trim().toLowerCase();

  filtered = rawRecords.filter(r=>{
    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (tp && r.tipo !== tp) return false;

    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;

    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }

    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  page = 1;
  fillMonthsCheckboxes();
  renderAll();
}

/* =========================
   COMPARAÇÃO MENSAL
========================= */
function fillMonthsCheckboxes() {
  const months = monthsAvailableFromFiltered();
  monthsCheckboxContainer.innerHTML = '';
  
  if (months.length === 0) {
    monthsCheckboxContainer.innerHTML = '<div class="text-sm muted p-3">Nenhum mês disponível com os filtros atuais</div>';
    return;
  }
  
  months.forEach(month => {
    const checkboxId = `month-${month}`;
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2';
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" value="${month}" class="rounded border-slate-300">
      <label for="${checkboxId}" class="text-sm cursor-pointer">${month}</label>
    `;
    
    const checkbox = div.querySelector('input');
    checkbox.checked = selectedMonths.has(month);
    checkbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        selectedMonths.add(month);
      } else {
        selectedMonths.delete(month);
      }
      renderMonthlyComparison();
    });
    
    monthsCheckboxContainer.appendChild(div);
  });
}

function monthsAvailableFromFiltered() {
  return uniqSorted(filtered.map(r => r.month).filter(Boolean));
}

function renderMonthlyComparison() {
  const months = Array.from(selectedMonths).sort();
  
  if (months.length === 0) {
    monthlyKPIs.innerHTML = '<div class="text-sm muted p-3">Selecione pelo menos um mês para visualizar a comparação</div>';
    destroyIfExists(compareChart1);
    destroyIfExists(compareChart2);
    compareTableBody.innerHTML = '';
    return;
  }
  
  // Dados por mês
  const monthlyData = months.map(month => {
    const monthRecords = filtered.filter(r => r.month === month && VALID_TIPOS.includes(r.tipo));
    
    // Contagem por tipo
    const counts = {};
    VALID_TIPOS.forEach(tipo => {
      counts[tipo] = monthRecords.filter(r => r.tipo === tipo).length;
    });
    
    // Total válido (apenas tipos válidos)
    const totalValid = monthRecords.length;
    
    // Acréscimos
    const acrescimos = monthRecords.reduce((sum, r) => sum + (r.acrescimo || 0), 0);
    
    return {
      month,
      counts,
      totalValid,
      acrescimos
    };
  });
  
  // Render KPIs por mês
  renderMonthlyKPIs(monthlyData);
  
  // Render gráficos
  renderComparisonCharts(monthlyData);
  
  // Render tabela comparativa
  renderComparisonTable(monthlyData);
}

function renderMonthlyKPIs(monthlyData) {
  monthlyKPIs.innerHTML = '';
  
  const container = document.createElement('div');
  container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3';
  
  monthlyData.forEach(data => {
    const div = document.createElement('div');
    div.className = 'card rounded-2xl p-4 bg-white';
    div.innerHTML = `
      <div class="text-sm font-semibold">${data.month}</div>
      <div class="mt-2 space-y-1 text-sm">
        <div class="flex justify-between">
          <span class="muted">Total:</span>
          <span class="mono font-semibold">${data.totalValid}</span>
        </div>
        <div class="flex justify-between">
          <span class="muted">Acréscimos:</span>
          <span class="mono font-semibold">${data.acrescimos}</span>
        </div>
        ${VALID_TIPOS.map(tipo => `
          <div class="flex justify-between">
            <span class="muted">${tipo}:</span>
            <span class="mono">${data.counts[tipo]}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(div);
  });
  
  monthlyKPIs.appendChild(container);
}

function renderComparisonCharts(monthlyData) {
  const months = monthlyData.map(d => d.month);
  
  // Gráfico 1: Comparação por tipo (agrupado)
  const datasets1 = VALID_TIPOS.map((tipo, idx) => {
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    return {
      label: tipo,
      data: monthlyData.map(d => d.counts[tipo]),
      backgroundColor: colors[idx % colors.length],
      borderColor: colors[idx % colors.length],
      borderWidth: 1
    };
  });
  
  destroyIfExists(compareChart1);
  compareChart1 = new Chart(el("compareChart1"), {
    type: 'bar',
    data: {
      labels: months,
      datasets: datasets1
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
  el("compareMeta1").textContent = `${months.length} mês(es) selecionado(s)`;
  
  // Gráfico 2: Evolução total mensal (linha)
  const totalData = monthlyData.map(d => d.totalValid);
  
  destroyIfExists(compareChart2);
  compareChart2 = new Chart(el("compareChart2"), {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Total de serviços',
        data: totalData,
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderColor: '#3b82f6',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
  el("compareMeta2").textContent = `${months.length} mês(es) selecionado(s)`;
}

function renderComparisonTable(monthlyData) {
  const months = monthlyData.map(d => d.month);
  
  // Cabeçalho
  const thead = document.querySelector('#compareTableBody').closest('table').querySelector('thead tr');
  thead.innerHTML = '<th class="p-2">Tipo</th>';
  months.forEach(month => {
    thead.innerHTML += `<th class="p-2">${month}</th>`;
  });
  thead.innerHTML += '<th class="p-2">Total</th>';
  
  // Corpo da tabela
  let tableHTML = '';
  
  // Linhas para cada tipo
  VALID_TIPOS.forEach(tipo => {
    const rowData = months.map(month => {
      const data = monthlyData.find(d => d.month === month);
      return data.counts[tipo] || 0;
    });
    const total = rowData.reduce((sum, val) => sum + val, 0);
    
    tableHTML += `
      <tr class="border-t hover:bg-slate-50">
        <td class="p-2 font-medium">${tipo}</td>
        ${rowData.map(val => `<td class="p-2 mono text-center">${val}</td>`).join('')}
        <td class="p-2 mono font-semibold text-center">${total}</td>
      </tr>
    `;
  });
  
  // Linha de total
  const totals = months.map(month => {
    const data = monthlyData.find(d => d.month === month);
    return data.totalValid;
  });
  const grandTotal = totals.reduce((sum, val) => sum + val, 0);
  
  tableHTML += `
    <tr class="border-t bg-slate-50">
      <td class="p-2 font-semibold">TOTAL</td>
      ${totals.map(val => `<td class="p-2 mono font-semibold text-center">${val}</td>`).join('')}
      <td class="p-2 mono font-semibold text-center">${grandTotal}</td>
    </tr>
  `;
  
  compareTableBody.innerHTML = tableHTML;
}

/* =========================
   KPIs + INSIGHTS
========================= */
function calcReinc(records){
  const win = Math.max(1, toInt(alertDias.value));
  const minCommon = Math.max(0, toInt(alertMinManut.value));

  const byClient = new Map();
  for (const r of records){
    const key = r.cliente || "(vazio)";
    if (!byClient.has(key)) byClient.set(key, []);
    byClient.get(key).push(r);
  }

  let reinc = 0, base=0;
  for (const arr of byClient.values()){
    const sorted = arr.filter(x=>x.data).sort((a,b)=>String(a.data).localeCompare(String(b.data)));
    for (let i=0;i<sorted.length;i++){
      base++;
      const cur = sorted[i];
      for (let j=i+1;j<sorted.length;j++){
        const nxt = sorted[j];
        const d = daysBetween(cur.data, nxt.data);
        if (d===null) continue;
        if (d>win) break;
        if (minCommon===0 || motivoSimilar(cur.motivo, nxt.motivo, minCommon)){
          reinc++; break;
        }
      }
    }
  }
  return {reinc, base, pct: base? Math.round((reinc/base)*100) : 0};
}

function sumEquip(records){
  let s=0;
  for (const r of records){
    for (const col of equipColumns){
      s += Math.max(0, toInt((r._raw||{})[col]));
    }
  }
  return s;
}

function avgChamadosPorDia(records){
  const byDay = groupCount(records, r=>r.data||"");
  const days = [...byDay.keys()].filter(Boolean).length;
  if (!days) return null;
  return records.length / days;
}

function currentMonth(records){
  const months = records.map(r=>r.month).filter(Boolean).sort();
  return months.length ? months[months.length-1] : "";
}

function trend7(records){
  const dates = records.map(r=>r.data).filter(Boolean).sort();
  if (!dates.length) return null;
  const max = dates[dates.length-1];
  const end = new Date(max+"T00:00:00Z");
  const d7a = new Date(end.getTime() - 6*86400000);
  const d7b = new Date(end.getTime() - 13*86400000);
  const iso = d=>d.toISOString().slice(0,10);

  const a0 = iso(d7a), a1 = max;
  const b0 = iso(d7b), b1 = iso(new Date(d7a.getTime()-86400000));

  const countRange = (x0,x1)=>records.filter(r=>r.data && r.data>=x0 && r.data<=x1).length;
  const A = countRange(a0,a1);
  const B = countRange(b0,b1);
  const pct = B ? Math.round(((A-B)/B)*100) : null;
  return {A,B,pct,range:`${a0}→${a1}`};
}

function isoWeekKey(iso){
  const d = new Date(iso+"T00:00:00Z");
  const day = (d.getUTCDay()+6)%7; // 0=Mon
  d.setUTCDate(d.getUTCDate() - day + 3); // quinta
  const year = d.getUTCFullYear();
  const firstThu = new Date(Date.UTC(year,0,4));
  const firstDay = (firstThu.getUTCDay()+6)%7;
  firstThu.setUTCDate(firstThu.getUTCDate() - firstDay + 3);
  const week = 1 + Math.round((d - firstThu)/86400000/7);
  return `${year}-W${String(week).padStart(2,"0")}`;
}
function calcProdSemana(records){
  const byW = new Map();
  for (const r of records){
    if (!r.data) continue;
    const w = isoWeekKey(r.data);
    byW.set(w, (byW.get(w)||0)+1);
  }
  const weeks = [...byW.values()];
  if (!weeks.length) return null;
  return weeks.reduce((a,b)=>a+b,0)/weeks.length;
}

function renderKPIs(){
  const mod = moduleSel.value;

  const total = filtered.length;
  const acresc = filtered.reduce((a,r)=>a+(r.acrescimo||0),0);
  const equipS = sumEquip(filtered);
  const reinc = calcReinc(filtered);
  const prod = avgChamadosPorDia(filtered);

  const tr = trend7(filtered);
  const cm = currentMonth(filtered);

  currentMonthLabel.textContent = cm || "—";
  trendLabel.textContent = tr ? (tr.pct===null ? `${tr.A}` : `${tr.pct}%`) : "—";

  const cards = [];
  if (mod === "operacoes"){
    const mix = groupCount(filtered.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
    const topTipo = topN(mix, 1)[0] ? `${topN(mix,1)[0][0]} (${topN(mix,1)[0][1]})` : "—";

    const daySet = new Set(filtered.map(r=>r.data).filter(Boolean));
    const carSet = new Set(filtered.map(r=>r.carro).filter(Boolean));
    const daysWithData = daySet.size || 0;
    const cars = carSet.size || 0;

    const avgPerDay = daysWithData ? (total / daysWithData) : null;
    const avgPerDayPerCar = (daysWithData && cars) ? (total / (daysWithData * cars)) : null;
    const estMonth = avgPerDay ? (avgPerDay * 30.42) : null;

    cards.push({t:"Chamados", v: total, s:"no recorte"});
    cards.push({t:"Maior fatia", v: topTipo, s:"mix de tipo"});
    cards.push({t:"Média (dia / carro)", v: (avgPerDayPerCar===null?"—":avgPerDayPerCar.toFixed(2)), s: `${daysWithData||"—"} dia(s) • ${cars||"—"} carro(s)`});
    cards.push({t:"Média (cham./mês)", v: (estMonth===null?"—":estMonth.toFixed(0)), s:"estimativa via média/dia"});
    cards.push({t:"Acréscimos", v: acresc, s:"soma do recorte"});
    cards.push({t:"Equip (qty)", v: equipS, s:"soma nas colunas detectadas"});
  } else {
    const techSet = new Set(filtered.map(r=>r.tecnico).filter(Boolean));
    const techCount = techSet.size;

    const tech = fTecnico.value.trim();
    const recTech = tech ? filtered.filter(r=>r.tecnico===tech) : filtered;
    const prodDia = avgChamadosPorDia(recTech);
    const prodSemana = calcProdSemana(recTech);

    cards.push({t:"Técnicos (no recorte)", v: techCount || "—", s:"únicos"});
    cards.push({t:"Chamados", v: total, s:"no recorte"});
    cards.push({t:"Prod/dia", v: prodDia===null ? "—" : prodDia.toFixed(2), s: tech ? `técnico: ${tech}` : "base atual"});
    cards.push({t:"Prod/semana", v: prodSemana===null ? "—" : prodSemana.toFixed(2), s:"média (ISO week)"});
  }

  kpiGrid.innerHTML = "";
  for (const c of cards){
    const div = document.createElement("div");
    div.className = "card rounded-2xl p-4 bg-white";
    div.innerHTML = `
      <div class="text-xs muted">${escapeHtml(c.t)}</div>
      <div class="text-2xl font-semibold mono kpiVal">${escapeHtml(c.v)}</div>
      <div class="text-xs muted">${escapeHtml(c.s)}</div>
    `;
    kpiGrid.appendChild(div);
  }
}

/* =========================
   EQUIP por TIPO DOMINANTE
========================= */
function equipTotalsByTipo(records, tipo){
  const m = new Map();
  for (const r of records){
    if (r.tipo !== tipo) continue;
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) m.set(col, (m.get(col)||0)+v);
    }
  }
  return m;
}

function renderDominantEquip(){
  const mod = moduleSel.value;
  if (mod !== "operacoes"){
    opDominantEquip.classList.add("hidden");
    opDominantEquip.innerHTML = "";
    return;
  }

  const baseFilteredNoTipo = rawRecords.filter(r=>{
    const base = fBase.value.trim();
    const c = fCliente.value.trim();
    const t = fTecnico.value.trim();
    const eq= fEquip.value.trim();
    const de= fDe.value ? fDe.value : "";
    const ate= fAte.value ? fAte.value : "";
    const s = fSearch.value.trim().toLowerCase();

    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;
    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }
    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  const mix = groupCount(baseFilteredNoTipo.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
  const top = topN(mix, 1)[0];
  if (!top){
    opDominantEquip.classList.add("hidden");
    opDominantEquip.innerHTML = "";
    return;
  }

  const dominantTipo = top[0];
  const totals = equipTotalsByTipo(baseFilteredNoTipo, dominantTipo);
  const topEquip = topN(totals, 8);

  const leader = topEquip[0] ? `${topEquip[0][0]} (× ${topEquip[0][1]})` : "—";

  opDominantEquip.classList.remove("hidden");
  opDominantEquip.innerHTML = `
    <div class="flex items-start justify-between flex-wrap gap-2">
      <div>
        <div class="text-lg font-semibold">Pergunta de reunião: "A maior fatia foi ${escapeHtml(dominantTipo)}. Qual equipamento liderou?"</div>
        <div class="text-xs muted">Ranking por qty nas colunas de equipamento (no recorte atual, ignorando o filtro de tipo).</div>
      </div>
      <div class="chip rounded-xl px-3 py-2 bg-slate-50 text-xs">
        <span class="muted">Líder:</span> <span class="mono font-semibold">${escapeHtml(leader)}</span>
      </div>
    </div>

    <div class="mt-3 overflow-auto border rounded-2xl">
      <table class="min-w-full text-sm bg-white">
        <thead class="bg-slate-100">
          <tr class="text-left">
            <th class="p-2">Equipamento</th>
            <th class="p-2">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          ${topEquip.map(([k,v])=>`
            <tr class="border-t hover:bg-slate-50">
              <td class="p-2">${escapeHtml(k)}</td>
              <td class="p-2 mono font-semibold">${v}</td>
            </tr>
          `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="2">Sem dados de equipamento nesse tipo.</td></tr>`}
        </tbody>
      </table>
    </div>
  `;
}

/* =========================
   SAÚDE POR EQUIPAMENTO
========================= */
function renderEquipHealth(){
  const mod = moduleSel.value;
  if (mod !== "operacoes"){
    equipHealthWrap.classList.add("hidden");
    equipHealthWrap.innerHTML = "";
    return;
  }

  if (!equipColumns.length){
    equipHealthWrap.classList.remove("hidden");
    equipHealthWrap.innerHTML = `
      <div class="text-lg font-semibold">Saúde por equipamento</div>
      <div class="text-xs muted mt-1">Não encontrei colunas de equipamento (somente colunas numéricas fora dos campos fixos).</div>
    `;
    return;
  }

  const selected = healthSelectedCol && equipColumns.includes(healthSelectedCol)
    ? healthSelectedCol
    : equipColumns[0];

  const win = Math.max(1, toInt(healthWindowDays.value));

  const baseRec = rawRecords.filter(r=>{
    const base = fBase.value.trim();
    const c = fCliente.value.trim();
    const t = fTecnico.value.trim();
    const eq= fEquip.value.trim();
    const de= fDe.value ? fDe.value : "";
    const ate= fAte.value ? fAte.value : "";
    const s = fSearch.value.trim().toLowerCase();

    if (base && r.base !== base) return false;
    if (c && r.cliente !== c) return false;
    if (t && r.tecnico !== t) return false;
    if (de && r.data && r.data < de) return false;
    if (ate && r.data && r.data > ate) return false;
    if (s){
      const hay = `${r.base} ${r.chamado} ${r.motivo} ${r.cliente} ${r.tecnico} ${r.tipo}`.toLowerCase();
      if (!hay.includes(s)) return false;
    }
    if (eq){
      const num = toInt((r._raw||{})[eq]);
      if (!(num>0)) return false;
    }
    return true;
  });

  const maintMap = new Map();
  for (const col of equipColumns){
    let qty = 0;
    for (const r of baseRec){
      if (r.tipo !== "Manutenção") continue;
      qty += Math.max(0, toInt((r._raw||{})[col]));
    }
    if (qty>0) maintMap.set(col, qty);
  }
  const topMaint = topN(maintMap, 10);

  const maintTotal = maintMap.get(selected) || 0;

  let montCount = 0;
  for (const r of baseRec){
    if (r.tipo !== "Montagem") continue;
    const q = toInt((r._raw||{})[selected]);
    if (q>0) montCount += q;
  }

  const flagged = postDeliveryMaintenance(baseRec, selected, win);
  const flaggedCount = flagged.length;
  const pct = montCount ? Math.round((flaggedCount / montCount) * 100) : 0;

  const allMaintDates = [];
  for (const r of baseRec){
    if (!r.data) continue;
    if (r.tipo !== "Manutenção") continue;
    const q = toInt((r._raw||{})[selected]);
    if (q>0) allMaintDates.push(r.data);
  }
  allMaintDates.sort();
  let avgGapGlobal = null;
  if (allMaintDates.length >= 2){
    const gaps = [];
    for (let i=1;i<allMaintDates.length;i++){
      gaps.push(daysBetween(allMaintDates[i-1], allMaintDates[i]));
    }
    avgGapGlobal = Math.round(gaps.reduce((a,b)=>a+b,0)/gaps.length);
  }

  equipHealthWrap.classList.remove("hidden");
  equipHealthWrap.innerHTML = `
    <div class="flex items-start justify-between flex-wrap gap-3">
      <div>
        <div class="text-lg font-semibold">Saúde por equipamento (todos)</div>
        <div class="text-xs muted">
          Responde: "qual equipamento está dando manutenção com mais frequência?", "quanto tempo entre falhas (proxy)?", "entrega virou manutenção rápido?".
        </div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs muted">Equipamento:</span>
        <select id="healthEquipSel" class="btn px-3 py-2 rounded-xl bg-white text-sm">
          ${equipColumns.map(c=>`<option value="${escapeHtml(c)}" ${c===selected?"selected":""}>${escapeHtml(c)}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
      <div class="card rounded-2xl p-3 bg-slate-50">
        <div class="text-xs muted">Manutenção (qty)</div>
        <div class="text-2xl font-semibold mono">${maintTotal}</div>
      </div>
      <div class="card rounded-2xl p-3 bg-slate-50">
        <div class="text-xs muted">Gap médio (dias)</div>
        <div class="text-2xl font-semibold mono">${avgGapGlobal===null?"—":avgGapGlobal}</div>
      </div>
      <div class="card rounded-2xl p-3 bg-slate-50">
        <div class="text-xs muted">Pós-montagem (até ${win}d)</div>
        <div class="text-2xl font-semibold mono">${flaggedCount}</div>
      </div>
      <div class="card rounded-xl p-3 bg-slate-50">
        <div class="text-xs muted">% pós-montagem</div>
        <div class="text-2xl font-semibold mono">${montCount?`${pct}%`:"—"}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-3">
      <div class="card rounded-2xl p-3 bg-white">
        <div class="text-sm font-semibold">Top equipamentos por manutenção (qty)</div>
        <div class="text-xs muted">Base: recorte atual (filtros), tipo=Manutenção</div>
        <div class="mt-2 overflow-auto border rounded-2xl max-h-72">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr class="text-left"><th class="p-2">Equipamento</th><th class="p-2">Qty</th></tr>
            </thead>
            <tbody>
              ${topMaint.map(([k,v])=>`
                <tr class="border-t hover:bg-slate-50">
                  <td class="p-2">${escapeHtml(k)}</td>
                  <td class="p-2 mono font-semibold">${v}</td>
                </tr>
              `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="2">Sem manutenção detectada no recorte.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-3 bg-white">
        <div class="text-sm font-semibold">Casos: Montagem → Manutenção (até ${win} dias)</div>
        <div class="text-xs muted">Chave: base + cliente + coluna de equipamento (sem serial/patrimônio).</div>
        <div class="mt-2 overflow-auto border rounded-2xl max-h-72">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr class="text-left">
                <th class="p-2">Base</th>
                <th class="p-2">Cliente</th>
                <th class="p-2">Montagem</th>
                <th class="p-2">Manut.</th>
                <th class="p-2">Δ dias</th>
              </tr>
            </thead>
            <tbody>
              ${flagged.slice(0, 30).map(x=>`
                <tr class="border-t hover:bg-slate-50">
                  <td class="p-2">${escapeHtml(x.base)}</td>
                  <td class="p-2">${escapeHtml(x.cliente)}</td>
                  <td class="p-2 mono">${escapeHtml(x.montagem)}</td>
                  <td class="p-2 mono">${escapeHtml(x.manutencao)}</td>
                  <td class="p-2 mono font-semibold">${x.deltaDays}</td>
                </tr>
              `).join("") || `<tr class="border-t"><td class="p-2 muted" colspan="5">Nenhum caso detectado no recorte.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-3 text-xs muted">
      Nota técnica: isso é um <b>proxy</b> (mesmo cliente + mesma coluna/modelo). Para "mesmo equipamento físico", precisa de patrimônio/serial no XLSX.
    </div>
  `;

  const sel = el("healthEquipSel");
  sel.addEventListener("change", ()=>{
    healthSelectedCol = sel.value;
    renderEquipHealth();
  });
}

function postDeliveryMaintenance(records, equipCol, windowDays=14){
  const byKey = new Map();
  const keyFn = (r)=> `${r.base||""}||${r.cliente||"(vazio)"}||${equipCol}`;

  for (const r of records){
    if (!r.data) continue;
    const qty = toInt((r._raw||{})[equipCol]);
    if (!(qty > 0)) continue;
    if (r.tipo !== "Montagem" && r.tipo !== "Manutenção") continue;

    const k = keyFn(r);
    if (!byKey.has(k)) byKey.set(k, {cliente:r.cliente||"(vazio)", base:r.base||"", montagens:[], manut:[]});
    if (r.tipo === "Montagem") byKey.get(k).montagens.push(r.data);
    if (r.tipo === "Manutenção") byKey.get(k).manut.push(r.data);
  }

  const flagged = [];
  for (const obj of byKey.values()){
    obj.montagens.sort();
    obj.manut.sort();
    if (!obj.montagens.length || !obj.manut.length) continue;

    let j=0;
    for (const mDate of obj.montagens){
      while (j < obj.manut.length && obj.manut[j] < mDate) j++;
      if (j >= obj.manut.length) break;
      const delta = daysBetween(mDate, obj.manut[j]);
      if (delta !== null && delta >= 0 && delta <= windowDays){
        flagged.push({
          base: obj.base,
          cliente: obj.cliente,
          equip: equipCol,
          montagem: mDate,
          manutencao: obj.manut[j],
          deltaDays: delta
        });
      }
    }
  }
  flagged.sort((a,b)=>a.deltaDays - b.deltaDays);
  return flagged;
}

/* =========================
   GRÁFICOS
========================= */
function buildCharts(){
  const mod = moduleSel.value;

  // Chart 1: chamados por dia
  let baseForChart = filtered;
  if (mod === "rh" && fTecnico.value.trim()){
    baseForChart = filtered.filter(r=>r.tecnico===fTecnico.value.trim());
  }

  const byDay = groupCount(baseForChart, r=>r.data || "(sem data)");
  const dayEntries = [...byDay.entries()].sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
  const labelsDay = dayEntries.map(([k])=>k);
  const dataDay   = dayEntries.map(([,v])=>v);
  el("g1meta").textContent = `${labelsDay.length} dia(s)`;

  destroyIfExists(chart1);
  chart1 = new Chart(el("chart1"), {
    type:"line",
    data:{ labels: labelsDay, datasets:[{ label:"Chamados", data: dataDay, tension:0.25 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ x:{ticks:{maxRotation:0,autoSkip:true}}, y:{beginAtZero:true,ticks:{precision:0}} }
    }
  });

  // Chart 2: Mix de tipo
  const mix = groupCount(filtered.filter(r=>VALID_TIPOS.includes(r.tipo)), r=>r.tipo);
  const mixEntries = VALID_TIPOS.map(t=>[t, mix.get(t)||0]).filter(([,v])=>v>0);
  el("g2meta").textContent = `${mixEntries.reduce((a,[,v])=>a+v,0)} chamados`;

  destroyIfExists(chart2);
  chart2 = new Chart(el("chart2"), {
    type:"pie",
    data:{
      labels: mixEntries.map(([k])=>k),
      datasets:[{ label:"Mix", data: mixEntries.map(([,v])=>v) }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{
          display:true,
          position:"bottom",
          onClick: (e, item, legend)=>{
            const chart = legend.chart;
            chart.toggleDataVisibility(item.index);
            chart.update();

            const ds = chart.data.datasets[0];
            let visTotal = 0;
            for (let i=0;i<ds.data.length;i++){
              if (chart.getDataVisibility(i)) visTotal += Number(ds.data[i]||0);
            }
            el("g2meta").textContent = `${visTotal} chamados`;
          }
        }
      }
    }
  });

  // Chart 3: Operacional => Top clientes; RH => Top técnicos
  destroyIfExists(chart3);
  if (mod === "operacoes"){
    el("g3title").textContent = "Top clientes (volume)";
    const byClient = groupCount(filtered, r=>r.cliente || "(vazio)");
    const clientTop = topN(byClient, 10);
    el("g3meta").textContent = `Top ${clientTop.length}`;
    chart3 = new Chart(el("chart3"), {
      type:"bar",
      data:{ labels: clientTop.map(([k])=>k), datasets:[{ label:"Chamados", data: clientTop.map(([,v])=>v) }] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
    });
  } else {
    el("g3title").textContent = "Chamados por técnico";
    const byTech = groupCount(filtered, r=>r.tecnico || "(vazio)");
    const techTop = topN(byTech, 10);
    el("g3meta").textContent = `Top ${techTop.length}`;
    chart3 = new Chart(el("chart3"), {
      type:"bar",
      data:{ labels: techTop.map(([k])=>k), datasets:[{ label:"Chamados", data: techTop.map(([,v])=>v) }] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
    });
  }

  // Chart 4: Top equipamentos (qty)
  const eqMap = new Map();
  for (const r of filtered){
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) eqMap.set(col, (eqMap.get(col)||0)+v);
    }
  }
  const eqTop = topN(eqMap, 10);
  el("g4meta").textContent = `Top ${eqTop.length}`;

  destroyIfExists(chart4);
  chart4 = new Chart(el("chart4"), {
    type:"bar",
    data:{ labels: eqTop.map(([k])=>k), datasets:[{ label:"Quantidade", data: eqTop.map(([,v])=>v) }] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
  });

  // clique para drill
  el("chart3").onclick = (evt)=>{
    const points = chart3.getElementsAtEventForMode(evt, "nearest", {intersect:true}, true);
    if (!points.length) return;
    const label = chart3.data.labels[points[0].index];
    if (moduleSel.value==="operacoes") openDrill("cliente", label);
    else openDrill("tecnico", label);
  };
}

/* =========================
   TABELA + DRILL
========================= */
function renderTable(){
  pageSize = Number(el("pageSize").value || 50);
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  page = Math.min(page, totalPages);

  const start = (page - 1) * pageSize;
  const end = Math.min(total, start + pageSize);
  const slice = filtered.slice(start, end);

  tbody.innerHTML = "";
  for (const r of slice){
    const tr = document.createElement("tr");
    tr.className = "border-t hover:bg-slate-50";

    tr.innerHTML = `
      <td class="p-2">${escapeHtml(r.base)}</td>
      <td class="p-2 mono">${r.data || ""}</td>
      <td class="p-2 mono">${escapeHtml(r.chamado)}</td>
      <td class="p-2">
        <button class="underline decoration-dotted hover:decoration-solid" data-drill="cliente">${escapeHtml(r.cliente)}</button>
      </td>
      <td class="p-2">
        <button class="underline decoration-dotted hover:decoration-solid" data-drill="tecnico">${escapeHtml(r.tecnico)}</button>
      </td>
      <td class="p-2">${escapeHtml(r.tipo)}</td>
      <td class="p-2 mono">${r.acrescimo || 0}</td>
      <td class="p-2">${escapeHtml(r.motivo)}</td>
    `;

    tr.querySelectorAll("button[data-drill]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const kind = btn.getAttribute("data-drill");
        const label = btn.textContent.trim() || "(vazio)";
        if (moduleSel.value==="rh" && kind==="cliente") return;
        openDrill(kind, label);
      });
    });

    tbody.appendChild(tr);
  }

  pagerInfo.textContent = `Página ${page}/${totalPages} • linhas ${start+1}-${end} de ${total}`;
  btnPrev.disabled = (page<=1);
  btnNext.disabled = (page>=totalPages);
  btnPrev.classList.toggle("opacity-50", btnPrev.disabled);
  btnNext.classList.toggle("opacity-50", btnNext.disabled);
}

function openDrill(kind, label){
  drillModal.classList.remove("hidden");
  drillModal.classList.add("flex");

  let recs;
  if (kind==="tecnico") recs = filtered.filter(r=>(r.tecnico||"(vazio)")===label);
  else recs = filtered.filter(r=>(r.cliente||"(vazio)")===label);

  const acresc = recs.reduce((a,r)=>a+(r.acrescimo||0),0);
  const equipS = sumEquip(recs);
  const reinc = calcReinc(recs);
  const prod = avgChamadosPorDia(recs);

  dTitle.textContent = `Drill-down: ${kind.toUpperCase()} • ${label}`;
  dSub.textContent = `${recs.length} registro(s) no recorte atual`;

  const kpis = [];
  kpis.push(["Chamados", recs.length]);
  kpis.push(["Prod/dia", prod===null ? "—" : prod.toFixed(2)]);
  kpis.push(["Acréscimos", acresc]);
  kpis.push(["Equip (qty)", equipS]);
  kpis.push(["Reincidência", `${reinc.pct}%`]);

  dKpis.innerHTML = "";
  for (const [k,v] of kpis){
    const div = document.createElement("div");
    div.innerHTML = `<span class="muted">${escapeHtml(k)}:</span> ${mono(v)}`;
    dKpis.appendChild(div);
  }

  const byDay = groupCount(recs, r=>r.data || "(sem data)");
  const entries = [...byDay.entries()].sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
  const labels = entries.map(([k])=>k);
  const data   = entries.map(([,v])=>v);
  dMeta.textContent = `${labels.length} dia(s)`;

  destroyIfExists(dChart);
  dChart = new Chart(el("dChart"), {
    type:"line",
    data:{ labels, datasets:[{ label:"Chamados", data, tension:0.25 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ x:{ticks:{maxRotation:0,autoSkip:true}}, y:{beginAtZero:true,ticks:{precision:0}} }
    }
  });

  const topClients = topN(groupCount(recs, r=>r.cliente||"(vazio)"), 8);
  const topReasons = topN(groupCount(recs, r=>r.motivo||"(vazio)"), 8);

  dTopClients.innerHTML = topClients.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of topClients){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">(${v})</span>`;
    dTopClients.appendChild(div);
  }

  dTopReasons.innerHTML = topReasons.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of topReasons){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">(${v})</span>`;
    dTopReasons.appendChild(div);
  }

  const eqMap = new Map();
  for (const r of recs){
    for (const col of equipColumns){
      const v = toInt((r._raw||{})[col]);
      if (v>0) eqMap.set(col, (eqMap.get(col)||0)+v);
    }
  }
  const eqTop = topN(eqMap, 10);
  dTopEquip.innerHTML = eqTop.length ? "" : `<div class="muted">—</div>`;
  for (const [k,v] of eqTop){
    const div = document.createElement("div");
    div.innerHTML = `<span>${escapeHtml(k)}</span> <span class="mono font-semibold">× ${v}</span>`;
    dTopEquip.appendChild(div);
  }
}
function closeDrill(){
  drillModal.classList.add("hidden");
  drillModal.classList.remove("flex");
}

/* =========================
   AUTOCOMPLETE CLIENTE
========================= */
let clientNames = [];
function updateSuggest(query){
  const q = safeStr(query).toLowerCase();
  if (!q || !clientNames.length){
    clientSuggest.classList.add("hidden"); clientSuggest.innerHTML = ""; return;
  }
  const hits = clientNames.filter(n=>n.toLowerCase().includes(q)).slice(0, 12);
  if (!hits.length){
    clientSuggest.classList.add("hidden"); clientSuggest.innerHTML = ""; return;
  }
  clientSuggest.classList.remove("hidden");
  clientSuggest.innerHTML = hits.map(n=>`
    <button class="w-full text-left px-3 py-2 hover:bg-slate-50 border-b last:border-b-0" data-client="${escapeHtml(n)}">
      ${escapeHtml(n)}
    </button>
  `).join("");

  clientSuggest.querySelectorAll("button[data-client]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const name = btn.getAttribute("data-client");
      fCliente.value = name;
      clientSearch.value = name;
      clientSuggest.classList.add("hidden");
      applyFilters();
      setTimeout(()=>el("page-dashboard").scrollIntoView({behavior:"smooth", block:"start"}), 120);
    });
  });
}

/* =========================
   EXPORT
========================= */
function exportCSV(){
  const headers = ["base","data","month","chamado","cliente","tecnico","tipo","acrescimo","motivo","sheet", ...equipColumns];
  const lines = [headers.join(";")];

  for (const r of filtered){
    const row = [
      r.base, r.data, r.month, r.chamado, r.cliente, r.tecnico, r.tipo,
      String(r.acrescimo||0),
      r.motivo, r.sheet,
      ...equipColumns.map(c => String(toInt((r._raw||{})[c]) || 0))
    ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`);
    lines.push(row.join(";"));
  }
  downloadFile(`smartconecta_filtrado.csv`, lines.join("\n"), "text/csv;charset=utf-8");
}

function exportJSON(){
  const out = filtered.map(r=>{
    const eq = {};
    for (const c of equipColumns){
      const v = toInt((r._raw||{})[c]);
      if (v) eq[c]=v;
    }
    return {
      base:r.base,
      data:r.data, month:r.month,
      chamado:r.chamado, cliente:r.cliente, tecnico:r.tecnico,
      tipo:r.tipo, acrescimo:r.acrescimo||0,
      motivo:r.motivo, sheet:r.sheet,
      equipamentos:eq
    };
  });
  downloadFile(`smartconecta_filtrado.json`, JSON.stringify(out,null,2), "application/json;charset=utf-8");
}

function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   META + DROPDOWNS
========================= */
function fillSelect(selectEl, values){
  const cur = selectEl.value;
  selectEl.innerHTML = `<option value="">(Todos)</option>`;
  for (const v of values){
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    selectEl.appendChild(opt);
  }
  if (values.includes(cur)) selectEl.value = cur;
}

function refreshFilterOptions(){
  const clientes = uniqSorted(rawRecords.map(r=>r.cliente).filter(v=>v && v!=="(vazio)"));
  const tecnicos = uniqSorted(rawRecords.map(r=>r.tecnico).filter(v=>v && v!=="(vazio)"));
  const tipos    = uniqSorted(rawRecords.map(r=>r.tipo).filter(v=>v && v!=="(vazio)"));

  fillSelect(fCliente, clientes);
  fillSelect(fTecnico, tecnicos);

  const tiposOk = uniqSorted(tipos.filter(t=>VALID_TIPOS.includes(t)));
  fTipo.innerHTML = `<option value="">(Todos)</option>` + tiposOk.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

  fEquip.innerHTML = `<option value="">(Todos)</option>`;
  for (const col of equipColumns){
    const opt = document.createElement("option");
    opt.value = col; opt.textContent = col;
    fEquip.appendChild(opt);
  }

  clientNames = clientes;
  fillMonthsCheckboxes();
}

function renderMeta(){
  metaTotal.textContent = rawRecords.length ? String(rawRecords.length) : "—";
  const dates = rawRecords.map(r=>r.data).filter(Boolean).sort();
  metaPeriod.textContent = dates.length ? `${dates[0]} → ${dates[dates.length-1]}` : "—";
  metaEquip.textContent = String(equipColumns.length);
  metaFiltered.textContent = filtered.length ? String(filtered.length) : "—";
}

/* =========================
   NAVEGAÇÃO
========================= */
function showPage(pageKey){
  for (const [k, node] of Object.entries(pages)){
    node.classList.toggle("hidden", k !== pageKey);
  }
  navBtns.forEach(b=>{
    b.classList.toggle("activeNav", b.getAttribute("data-page")===pageKey);
  });

  if (pageKey==="comparativo") renderMonthlyComparison();
  if (pageKey==="alertas") renderAlerts();
}
navBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>showPage(btn.getAttribute("data-page")));
});

/* =========================
   RENDER GERAL
========================= */
function renderAll(){
  renderMeta();
  renderKPIs();
  buildCharts();
  renderDominantEquip();
  renderEquipHealth();
  renderTable();

  const ok = filtered.length > 0;
  btnExportCSV.disabled = !ok;
  btnExportJSON.disabled = !ok;
}

/* =========================
   RESET
========================= */
function resetFilters(reRender=true){
  fBase.value="";
  fCliente.value=""; fTecnico.value=""; fTipo.value=""; fEquip.value="";
  fDe.value=""; fAte.value=""; fSearch.value="";
  clientSearch.value="";
  clientSuggest.classList.add("hidden"); clientSuggest.innerHTML="";
  selectedMonths.clear();
  page=1;
  if (reRender) applyFilters();
}

/* =========================
   EVENTOS
========================= */
fileInput.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;

  dotStatus.className = "w-2.5 h-2.5 rounded-full bg-amber-500";
  statusLine.textContent = "Carregando…";

  try{
    rawRecords = await loadXLSX(file);
    if (!rawRecords.length) throw new Error("Planilha vazia ou sem dados válidos");
    
    equipColumns = detectEquipColumns(rawRecords);
    healthSelectedCol = null;
    selectedMonths.clear();

    refreshFilterOptions();
    applyModuleUI();
    resetFilters(false);

    dotStatus.className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
    statusLine.textContent = `${file.name} • ${rawRecords.length} registros`;

    applyFilters();
  }catch(err){
    console.error("Erro ao carregar arquivo:", err);
    dotStatus.className = "w-2.5 h-2.5 rounded-full bg-rose-500";
    statusLine.textContent = `Erro: ${err.message || "Formato inválido"}`;
    rawRecords = [];
    filtered = [];
    renderAll();
  }finally{
    fileInput.value="";
  }
});

moduleSel.addEventListener("change", ()=>{
  applyModuleUI();
  applyFilters();
});

btnReset.addEventListener("click", ()=>resetFilters(true));
btnExportCSV.addEventListener("click", exportCSV);
btnExportJSON.addEventListener("click", exportJSON);

[fBase, fCliente, fTecnico, fTipo, fEquip, fDe, fAte].forEach(x=>x.addEventListener("change", applyFilters));
fSearch.addEventListener("input", debounce(applyFilters, 300));

// Eventos de alertas
alertDias.addEventListener("change", renderAlerts);
alertMinManut.addEventListener("change", renderAlerts);
btnRefreshAlerts.addEventListener("click", renderAlerts);

healthWindowDays.addEventListener("change", renderEquipHealth);

el("pageSize").addEventListener("change", ()=>{ page=1; renderTable(); });
btnPrev.addEventListener("click", ()=>{ page=Math.max(1,page-1); renderTable(); });
btnNext.addEventListener("click", ()=>{ page=page+1; renderTable(); });

dClose.addEventListener("click", closeDrill);
drillModal.addEventListener("click", (e)=>{ if (e.target===drillModal) closeDrill(); });

clientSearch.addEventListener("input", ()=>updateSuggest(clientSearch.value));
clientSearch.addEventListener("keydown", (e)=>{
  if (e.key==="Enter"){
    e.preventDefault();
    const name = safeStr(clientSearch.value);
    if (clientNames.includes(name)){
      fCliente.value = name;
      clientSuggest.classList.add("hidden");
      applyFilters();
    }
  }
  if (e.key==="Escape") clientSuggest.classList.add("hidden");
});

document.addEventListener("keydown", (e)=>{
  if (e.key==="/"){
    e.preventDefault();
    if (moduleSel.value!=="rh") clientSearch.focus();
    else fSearch.focus();
  }
  if (e.key==="Escape"){
    closeDrill();
    clientSuggest.classList.add("hidden");
  }
});

function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* =========================
   INIT charts vazios
========================= */
(function initEmpty(){
  const empty = { type:"bar", data:{labels:[],datasets:[{data:[]}]}, options:{plugins:{legend:{display:false}}} };
  chart1 = new Chart(el("chart1"), {...empty, type:"line"});
  chart2 = new Chart(el("chart2"), {...empty, type:"pie"});
  chart3 = new Chart(el("chart3"), empty);
  chart4 = new Chart(el("chart4"), empty);

  compareChart1 = new Chart(el("compareChart1"), empty);
  compareChart2 = new Chart(el("compareChart2"), empty);

  // navegação inicial
  showPage("dashboard");
  applyModuleUI();
})();
</script>
</body>
</html>
